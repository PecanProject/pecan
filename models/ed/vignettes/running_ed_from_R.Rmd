---
title: "Running ED from R"
author: "Alexey Shiklomanov"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

# Introduction

The `PEcAn.ED2` package features a number of utilities to facilitate running the ED model from inside R, including
working with input files,
running the ED executable,
and processing the outputs.
This tutorial describes these utilites and provides examples of common use cases.

# Setup

## Installing the R package

The `PEcAn.ED2` package and its PEcAn dependencies can be installed from GitHub as follows (all CRAN package dependencies should be installed automatically):

```{r install}
devtools::install_github("pecanproject/pecan", ref = "develop", subdir = "base/logger")
devtools::install_github("pecanproject/pecan", ref = "develop", subdir = "base/utils")
devtools::install_github("pecanproject/pecan", ref = "develop", subdir = "base/settings")
devtools::install_github("pecanproject/pecan", ref = "develop", subdir = "models/ed")

library(PEcAn.ED2)
```

## Installing the ED2 model

The source code for the ED2 model is available [on GitHub](https://github.com/edmodel/ed2).

Alternatively, if you have [Singularity](https://singularity.lbl.gov) container software installed, you can use a pre-built Singularity container available on [Singularity Hub](https://www.singularity-hub.org/collections/642):

```
singularity pull --name ed2.simg shub://ashiklom/ED2
```

## Common ED inputs

ED requires a global land use database to determine its land-sea mask, as well as a vegetation "thermal sums" database.
These can be customized to some extent, but this package provides a version of the most common inputs.
These inputs, stored in an "EDI" directory, can be downloaded via the `download_edi` function:

```{r get_edi}
library(here)
rundir <- here("vignettes", "ed_run_data")
dir.create(rundir, showWarnings = FALSE)

edi_dir <- file.path(rundir, "EDI")
if (!file.exists(edi_dir)) {
  download_edi(edi_dir)
} else {
  message("EDI directory already exists. Skipping download.")
}
```

# Basic ED run

The two main components for a basic ED run are as follows:

- Meteorological driver data (in HDF5 format), and a driver header file (typically called `ED_MET_DRIVER_HEADER`)
- Three vegetation initial condition data files (unless you are doing a bare ground run), which consists of three interrelated files:
  * `css` -- Cohort file, which describes all plant cohorts located within a patch, including its PFT, DBH, and stand density
  * `pss` -- Patch file, which describes each patch within a site (single, plot-scale runs will often have only one patch)
  * `site` -- Site file, which describes each site (single, plot-scale runs will often have only one site)

Both of these inputs are site- and/or run-specific, so you will have to provide (or create) your own.
However, `PEcAn.ED2` provides templates and utility functions to facilitate creating and modifying both files.

Assuming you already have properly formatted inputs, doing an ED run requires creating an ED configuration (typically, an `ED2IN` file) and pointing the ED executable at it.

First, read a `ED2IN` template file:

```{r read_ed2in}
ed2in_raw <- read_ed2in(system.file("ED2IN.rgit", package = "PEcAn.ED2"))
```

Then, set up the `ED2IN` with the required components.

```{r modify_ed2in}
ed2in <- modify_ed2in(
  ed2in_raw,
  veg_prefix = "/path/to/vegetation_prefix_",   # Contains vegetation_prefix_lat*lon*.css
  latitude = 43.37,
  longitude = -89.91,
  met_driver = "/path/to/ED_MET_DRIVER_HEADER",
  EDI_path = file.path(rundir, "EDI"),
  start_date = "2001-07-01",
  end_date = "2001-07-10",
  run_dir = file.path(rundir, "run"),
  output_dir = file.path(rundir, "out"),
  runtype = "INITIAL",
  EXPNME = "ED test run"
)
```

It is also a good idea to check the `ED2IN` file for internal consistency.

```{r check_ed2in}
check_ed2in(ed2in)
```

Assuming the `ed2in` object is valid, you then write it to a file to a desired directory.
This doesn't have to be the run directory (nor does the file have to be named `ED2IN`), but it's a good idea to keep the `ED2IN` file close to the run outputs, as it provides useful metadata for the run.

```{r write_ed2in}
ed2in_path <- file.path(rundir, "ED2IN")
write_ed2in(ed2in, ed2in_path)
```

Finally, start the ED run!

```{r start_ed_run}
run_ed_singularity("/path/to/ed2.simg", ed2in_path)
```

# Utilities for working with ED files

## Meteorological inputs

```{r met_driver}
met_driver_raw <- "~/Projects/nasa-rtm/edr-da/ed-inputs/met3/US-Syv/ED_MET_DRIVER_HEADER.template"
met_driver_obj <- read_ed_metheader(met_driver_raw, check = FALSE)
met_driver_obj[[1]]$path_prefix <- "~/Projects/nasa-rtm/edr-da/ed-inputs/met3/US-Syv/US-Syv_"
met_driver_obj[[1]]$xmin <- -90
met_driver_obj[[1]]$ymin <- 43

met_driver_path <- file.path(rundir, "ED_MET_DRIVER_HEADER")
write_ed_metheader(met_driver_obj, met_driver_path)
```


```{r veg_input}
veg_prefix <- "~/Projects/nasa-rtm/edr-da/ed-inputs/sites/BH02_site_1-25665/FFT.2008"
latitude <- 43.3724
longitude <- -89.9071
veg_input <- read_ed_veg(veg_prefix, latitude = latitude, longitude = longitude)
```
