<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running ED from R • PEcAn.ED2</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running ED from R">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PEcAn.ED2</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.6.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/running_ed_from_R.html">Running ED from R</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Running ED from R</h1>
                        <h4 class="author">Alexey Shiklomanov</h4>
            
      
      
      <div class="hidden name"><code>running_ed_from_R.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The <code>PEcAn.ED2</code> package features a number of utilities to facilitate running the ED model from inside R, including working with input files, running the ED executable, and processing the outputs. This tutorial describes these utilites and provides examples of common use cases.</p>
</div>
<div id="basic-ed-run" class="section level1">
<h1 class="hasAnchor">
<a href="#basic-ed-run" class="anchor"></a>Basic ED run</h1>
<div id="installing-the-r-package" class="section level2">
<h2 class="hasAnchor">
<a href="#installing-the-r-package" class="anchor"></a>Installing the R package</h2>
<p>The <code>PEcAn.ED2</code> package and its PEcAn dependencies can be installed from GitHub as follows (all CRAN package dependencies should be installed automatically):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"pecanproject/pecan"</span>, <span class="dt">ref =</span> <span class="st">"develop"</span>, <span class="dt">subdir =</span> <span class="st">"base/logger"</span>)
devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"pecanproject/pecan"</span>, <span class="dt">ref =</span> <span class="st">"develop"</span>, <span class="dt">subdir =</span> <span class="st">"base/utils"</span>)
devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"pecanproject/pecan"</span>, <span class="dt">ref =</span> <span class="st">"develop"</span>, <span class="dt">subdir =</span> <span class="st">"base/settings"</span>)
devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"pecanproject/pecan"</span>, <span class="dt">ref =</span> <span class="st">"develop"</span>, <span class="dt">subdir =</span> <span class="st">"modules/data.atmosphere"</span>)
devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"pecanproject/pecan"</span>, <span class="dt">ref =</span> <span class="st">"develop"</span>, <span class="dt">subdir =</span> <span class="st">"models/ed"</span>)

<span class="kw">library</span>(PEcAn.ED2)</code></pre></div>
</div>
<div id="installing-the-ed2-model" class="section level2">
<h2 class="hasAnchor">
<a href="#installing-the-ed2-model" class="anchor"></a>Installing the ED2 model</h2>
<p>The source code for the ED2 model is available <a href="https://github.com/edmodel/ed2">on GitHub</a>.</p>
<p>Alternatively, if you have <a href="https://singularity.lbl.gov">Singularity</a> container software installed, you can use a pre-built Singularity container available on <a href="https://www.singularity-hub.org/collections/642">Singularity Hub</a>:</p>
<pre><code>singularity pull --name ed2.simg shub://ashiklom/ED2</code></pre>
</div>
<div id="ed-inputs" class="section level2">
<h2 class="hasAnchor">
<a href="#ed-inputs" class="anchor"></a>ED inputs</h2>
<div id="edi" class="section level3">
<h3 class="hasAnchor">
<a href="#edi" class="anchor"></a>EDI</h3>
<p>ED requires a global land use database to determine its land-sea mask, as well as a vegetation “thermal sums” database. These can be customized to some extent, but this package provides a version of the most common inputs. These inputs, stored in an “EDI” directory, can be downloaded via the <code>download_edi</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(here)
rundir &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/here/topics/here">here</a></span>(<span class="st">"vignettes"</span>, <span class="st">"ed_run_data"</span>)
<span class="kw">dir.create</span>(rundir, <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>)

edi_dir &lt;-<span class="st"> </span><span class="kw">file.path</span>(rundir, <span class="st">"EDI"</span>)
<span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(edi_dir)) {
  <span class="kw"><a href="../reference/download_edi.html">download_edi</a></span>(edi_dir)
} <span class="cf">else</span> {
  <span class="kw">message</span>(<span class="st">"EDI directory already exists. Skipping download."</span>)
}</code></pre></div>
</div>
<div id="meteorological-data" class="section level3">
<h3 class="hasAnchor">
<a href="#meteorological-data" class="anchor"></a>Meteorological data</h3>
<p>To do the ED run described here, we’ll need some meteorological data. ED meteorological data are typically stored in HDF5 format and are described by a plain text header file (typically called <code>ED_MET_DRIVER_HEADER</code>).</p>
<p>To download the meteorological data, we’ll use the <code>PEcAn.data.atmosphere</code> package. Here, we grab the data for the first week of July 2005 and Harvard Forest, for which we’ll be running the simulation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">start_date &lt;-<span class="st"> "2006-07-01"</span>
end_date &lt;-<span class="st"> "2006-07-08"</span>
latitude &lt;-<span class="st"> </span><span class="fl">42.53</span>
longitude &lt;-<span class="st"> </span><span class="op">-</span><span class="fl">72.19</span>

raw_met &lt;-<span class="st"> </span>PEcAn.data.atmosphere<span class="op">::</span><span class="kw">download.CRUNCEP</span>(
  <span class="dt">outfolder =</span> <span class="kw">file.path</span>(rundir, <span class="st">"raw_met"</span>),
  <span class="dt">start_date =</span> start_date,
  <span class="dt">end_date =</span> start_date,
  <span class="dt">site_id =</span> <span class="ot">NULL</span>,
  <span class="dt">lat.in =</span> latitude,
  <span class="dt">lon.in =</span> longitude
)</code></pre></div>
<p>Next, we convert this raw data to the ED-specific format.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ed_met &lt;-<span class="st"> </span><span class="kw"><a href="../reference/met2model.ED2.html">met2model.ED2</a></span>(
  <span class="dt">in.path =</span> <span class="kw">dirname</span>(raw_met<span class="op">$</span>file),
  <span class="dt">in.prefix =</span> <span class="st">"CRUNCEP"</span>,
  <span class="dt">outfolder =</span> <span class="kw">file.path</span>(rundir, <span class="st">"ed_met"</span>),
  <span class="dt">start_date =</span> start_date,
  <span class="dt">end_date =</span> start_date,
  <span class="dt">lat =</span> latitude,
  <span class="dt">lon =</span> longitude,
  <span class="dt">overwrite =</span> <span class="ot">TRUE</span>
)</code></pre></div>
<p>If you already have ED-specific meteorology available, <code>PEcAn.ED2</code> provides utilities to interact with that file directly:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">met_driver_raw &lt;-<span class="st"> "/path/to/ED_MET_DRIVER_HEADER"</span>
met_driver_obj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_ed_metheader.html">read_ed_metheader</a></span>(met_driver_raw, <span class="dt">check =</span> <span class="ot">FALSE</span>)
met_driver_obj[[<span class="dv">1</span>]]<span class="op">$</span>path_prefix &lt;-<span class="st"> "/path/to/new/location"</span>
met_driver_obj[[<span class="dv">1</span>]]<span class="op">$</span>xmin &lt;-<span class="st"> </span><span class="op">-</span><span class="dv">90</span>
met_driver_obj[[<span class="dv">1</span>]]<span class="op">$</span>ymin &lt;-<span class="st"> </span><span class="dv">43</span>

met_driver_path &lt;-<span class="st"> </span><span class="kw">file.path</span>(rundir, <span class="st">"ED_MET_DRIVER_HEADER"</span>)
<span class="kw"><a href="../reference/write_ed_metheader.html">write_ed_metheader</a></span>(met_driver_obj, met_driver_path)</code></pre></div>
</div>
<div id="vegetation-inputs" class="section level3">
<h3 class="hasAnchor">
<a href="#vegetation-inputs" class="anchor"></a>Vegetation inputs</h3>
<p>A common way to initialize ED is through three interrelated vegetation initial condition files:</p>
<ul>
<li>
<code>css</code> – Cohort file, which describes all plant cohorts located within a patch, including its PFT, DBH, and stand density</li>
<li>
<code>pss</code> – Patch file, which describes each patch within a site (single, plot-scale runs will often have only one patch)</li>
<li>
<code>site</code> – Site file, which describes each site (single, plot-scale runs will often have only one site)</li>
</ul>
<p>The package ships with simple functional examples of these objects (<code>example_css/pss/site</code>) and functions for quickly creating custom objects based on these examples (<code>create_css/pss/site</code>). Below, we create a <code>css</code> file with a single PFT with a specific DBH, but stick to the unmodified example <code>pss</code> and <code>site</code> files.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">css &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_css.html">create_css</a></span>(<span class="kw">list</span>(<span class="dt">pft =</span> <span class="dv">11</span>, <span class="dt">dbh =</span> <span class="fl">18.00</span>))
pss &lt;-<span class="st"> </span>example_pss
site &lt;-<span class="st"> </span>example_site
veg_input &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_ed_veg.html">create_ed_veg</a></span>(css, pss, site, latitude, longitude, <span class="dt">check =</span> <span class="ot">TRUE</span>)

veg_prefix &lt;-<span class="st"> </span><span class="kw">file.path</span>(rundir, <span class="st">"veg_input"</span>, <span class="st">"test_veg"</span>)
<span class="kw"><a href="../reference/write_ed_veg.html">write_ed_veg</a></span>(veg_input, veg_prefix)</code></pre></div>
<p>As with meteorology, <code>PEcAn.ED2</code> also provides utilities for working with existing vegetation inputs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">veg_prefix &lt;-<span class="st"> "/path/to/site/files/prefix"</span>
latitude &lt;-<span class="st"> </span><span class="fl">43.3724</span>
longitude &lt;-<span class="st"> </span><span class="op">-</span><span class="fl">89.9071</span>
veg_input &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_ed_veg.html">read_ed_veg</a></span>(veg_prefix, <span class="dt">latitude =</span> latitude, <span class="dt">longitude =</span> longitude)</code></pre></div>
</div>
<div id="ed-configuration-file" class="section level3">
<h3 class="hasAnchor">
<a href="#ed-configuration-file" class="anchor"></a>ED configuration file</h3>
<p>Now that all inputs are taken care of, the final step is to create the ED configuration file (typically called <code>ED2IN</code>).</p>
<p>First, read a <code>ED2IN</code> template file:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ed2in_raw &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_ed2in.html">read_ed2in</a></span>(<span class="kw">system.file</span>(<span class="st">"ED2IN.rgit"</span>, <span class="dt">package =</span> <span class="st">"PEcAn.ED2"</span>))</code></pre></div>
<p>Then, set up the <code>ED2IN</code> with the required components.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ed2in &lt;-<span class="st"> </span><span class="kw"><a href="../reference/modify_ed2in.html">modify_ed2in</a></span>(
  ed2in_raw,
  <span class="dt">veg_prefix =</span> veg_prefix,
  <span class="dt">latitude =</span> latitude,
  <span class="dt">longitude =</span> longitude,
  <span class="dt">met_driver =</span> ed_met<span class="op">$</span>file,
  <span class="dt">EDI_path =</span> <span class="kw">file.path</span>(rundir, <span class="st">"EDI"</span>),
  <span class="dt">start_date =</span> start_date,
  <span class="dt">end_date =</span> end_date,
  <span class="dt">run_dir =</span> <span class="kw">file.path</span>(rundir, <span class="st">"run"</span>),
  <span class="dt">output_dir =</span> <span class="kw">file.path</span>(rundir, <span class="st">"out"</span>),
  <span class="dt">runtype =</span> <span class="st">"INITIAL"</span>,
  <span class="dt">EXPNME =</span> <span class="st">"ED test run"</span>
)</code></pre></div>
<p>It is also a good idea to check the <code>ED2IN</code> file for internal consistency.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/check_ed2in.html">check_ed2in</a></span>(ed2in)</code></pre></div>
<p>Assuming the <code>ed2in</code> object is valid, you then write it to a file to a desired directory. This doesn’t have to be the run directory (nor does the file have to be named <code>ED2IN</code>), but it’s a good idea to keep the <code>ED2IN</code> file close to the run outputs, as it provides useful metadata for the run.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ed2in_path &lt;-<span class="st"> </span><span class="kw">file.path</span>(rundir, <span class="st">"ED2IN"</span>)
<span class="kw"><a href="../reference/write_ed2in.html">write_ed2in</a></span>(ed2in, ed2in_path)</code></pre></div>
</div>
<div id="running-ed" class="section level3">
<h3 class="hasAnchor">
<a href="#running-ed" class="anchor"></a>Running ED</h3>
<p>Assuming all of the inputs are correct, running ED is as simple as calling the <code>run_ed_singularity</code> function, which requires paths to the Singularity image and ED2IN file.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">img_path &lt;-<span class="st"> "~/Projects/ED2/ed2.simg"</span>
<span class="kw"><a href="../reference/run_ed_singularity.html">run_ed_singularity</a></span>(img_path, ed2in_path)</code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li>
<a href="#basic-ed-run">Basic ED run</a><ul class="nav nav-pills nav-stacked">
<li><a href="#installing-the-r-package">Installing the R package</a></li>
      <li><a href="#installing-the-ed2-model">Installing the ED2 model</a></li>
      <li><a href="#ed-inputs">ED inputs</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by .</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
