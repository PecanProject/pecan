<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running MAAT in PEcAn â€¢ PEcAn.MAAT</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running MAAT in PEcAn">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PEcAn.MAAT</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.6.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/create_amerifluxLBL_drivers_for_maat.html">PEcAn: Generating met drivers for the MAAT model using AmerifluxLBL tower observations</a>
    </li>
    <li>
      <a href="../articles/running_maat_in_pecan.html">Running MAAT in PEcAn</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Running MAAT in PEcAn</h1>
                        <h4 class="author">Shawn Serbin</h4>
            
            <h4 class="date">2018-08-28</h4>
      
      
      <div class="hidden name"><code>running_maat_in_pecan.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>A simple example to show how to setup and run MAAT simulations within the PEcAn framework. Running the MAAT model within PEcAn provides access to additional tools such as the PEcAn met process functions that enable the creation of model-specific met driver files using various sources such as reanalysis products including CRU-NCEP and NARR, as well as site-level tower observations from AmerifluxLBL and FLUXNET. In addition, the PEcAn framework provides the ability to define custom plant functional types (PFTs) for MAAT simulation and conduct multi-ensemble simulations using observationally-constrained MAAT parameter distributions based on a hierarchical Bayesian meta-analysis approach linked to the BETYdb trait database (betydb.org).</p>
<p>Presently the full MAAT process representation, functionality and tools are not yet fully enabled in the PEcAn framework but adding in more the MAAT functionality is planned in future updates to the PEcAn wrapper code.</p>
<div id="maat-installation-and-usage" class="section level2">
<h2 class="hasAnchor">
<a href="#maat-installation-and-usage" class="anchor"></a>MAAT Installation and usage</h2>
<p><strong>MAAT model source:</strong> <a href="https://github.com/walkeranthonyp/MAAT" class="uri">https://github.com/walkeranthonyp/MAAT</a> <br> Follow the instructions found here: <a href="https://github.com/walkeranthonyp/MAAT/blob/master/README.html" class="uri">https://github.com/walkeranthonyp/MAAT/blob/master/README.md</a> <br></p>
</div>
<div id="installing-the-r-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#installing-the-r-packages" class="anchor"></a>Installing the R packages</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"pecanproject/pecan"</span>, <span class="dt">ref =</span> <span class="st">"develop"</span>, <span class="dt">subdir =</span> <span class="st">"base/logger"</span>)
devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"PecanProject/pecan"</span>, <span class="dt">ref =</span> <span class="st">"develop"</span>, <span class="dt">subdir=</span> <span class="st">"base/remote"</span>)
devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"pecanproject/pecan"</span>, <span class="dt">ref =</span> <span class="st">"develop"</span>, <span class="dt">subdir =</span> <span class="st">"base/utils"</span>)
devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"pecanproject/pecan"</span>, <span class="dt">ref =</span> <span class="st">"develop"</span>, <span class="dt">subdir =</span> <span class="st">"base/settings"</span>)
devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"pecanproject/pecan"</span>, <span class="dt">ref =</span> <span class="st">"develop"</span>, <span class="dt">subdir =</span> <span class="st">"modules/data.atmosphere"</span>)
devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"pecanproject/pecan"</span>, <span class="dt">ref =</span> <span class="st">"develop"</span>, <span class="dt">subdir =</span> <span class="st">"models/maat"</span>)

<span class="kw">library</span>(PEcAn.MAAT)</code></pre></div>
</div>
<div id="maat-xml-configuration" class="section level2">
<h2 class="hasAnchor">
<a href="#maat-xml-configuration" class="anchor"></a>MAAT XML configuration</h2>
<div id="e-g--running-without-met-drivers-and-using-user-specified-met-conditions" class="section level3">
<h3 class="hasAnchor">
<a href="#e-g--running-without-met-drivers-and-using-user-specified-met-conditions" class="anchor"></a>E.g. Running without met drivers and using user-specified met conditions</h3>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;config&gt;</span>
  <span class="kw">&lt;mod_obj&gt;</span>leaf<span class="kw">&lt;/mod_obj&gt;</span>
  <span class="kw">&lt;leaf&gt;</span>
    <span class="kw">&lt;fnames&gt;</span>
      <span class="kw">&lt;vcmax&gt;</span>'f_vcmax_constant'<span class="kw">&lt;/vcmax&gt;</span>
      <span class="kw">&lt;jmax&gt;</span>'f_jmax_constant'<span class="kw">&lt;/jmax&gt;</span>
      <span class="kw">&lt;rd&gt;</span>'f_rd_constant'<span class="kw">&lt;/rd&gt;</span>
      <span class="kw">&lt;rs&gt;</span>'f_rs_ball1987'<span class="kw">&lt;/rs&gt;</span>
      <span class="kw">&lt;etrans&gt;</span>'f_j_farquharwong1984'<span class="kw">&lt;/etrans&gt;</span>
     <span class="kw">&lt;/fnames&gt;</span>
     <span class="kw">&lt;env&gt;</span>
      <span class="kw">&lt;ca_conc&gt;</span>400<span class="kw">&lt;/ca_conc&gt;</span>
      <span class="kw">&lt;temp&gt;</span>30<span class="kw">&lt;/temp&gt;</span>
      <span class="kw">&lt;o2_conc&gt;</span>0.21<span class="kw">&lt;/o2_conc&gt;</span>
      <span class="kw">&lt;par&gt;</span>1500<span class="kw">&lt;/par&gt;</span>
      <span class="kw">&lt;water_l&gt;</span>0<span class="kw">&lt;/water_l&gt;</span>
      <span class="kw">&lt;sphag_l&gt;</span>0<span class="kw">&lt;/sphag_l&gt;</span>
      <span class="kw">&lt;vpd&gt;</span>1<span class="kw">&lt;/vpd&gt;</span>
      <span class="kw">&lt;rh&gt;</span>0<span class="kw">&lt;/rh&gt;</span>
      <span class="kw">&lt;atm_press&gt;</span>101325<span class="kw">&lt;/atm_press&gt;</span>
      <span class="kw">&lt;wind&gt;</span>1<span class="kw">&lt;/wind&gt;</span>
     <span class="kw">&lt;/env&gt;</span>
  <span class="kw">&lt;/leaf&gt;</span>
<span class="kw">&lt;/config&gt;</span></code></pre></div>
</div>
<div id="e-g--running-with-met-drivers" class="section level3">
<h3 class="hasAnchor">
<a href="#e-g--running-with-met-drivers" class="anchor"></a>E.g. Running with met drivers</h3>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;config&gt;</span>
  <span class="kw">&lt;mod_obj&gt;</span>leaf<span class="kw">&lt;/mod_obj&gt;</span>
  <span class="kw">&lt;leaf&gt;</span>
    <span class="kw">&lt;fnames&gt;</span>
      <span class="kw">&lt;vcmax&gt;</span>'f_vcmax_constant'<span class="kw">&lt;/vcmax&gt;</span>
      <span class="kw">&lt;jmax&gt;</span>'f_jmax_constant'<span class="kw">&lt;/jmax&gt;</span>
      <span class="kw">&lt;rd&gt;</span>'f_rd_constant'<span class="kw">&lt;/rd&gt;</span>
      <span class="kw">&lt;rs&gt;</span>'f_rs_ball1987'<span class="kw">&lt;/rs&gt;</span>
      <span class="kw">&lt;etrans&gt;</span>'f_j_farquharwong1984'<span class="kw">&lt;/etrans&gt;</span>
     <span class="kw">&lt;/fnames&gt;</span>
  <span class="kw">&lt;/leaf&gt;</span>
<span class="kw">&lt;/config&gt;</span></code></pre></div>
</div>
</div>
<div id="full-pecan-xml-configuration-with-maat-options" class="section level2">
<h2 class="hasAnchor">
<a href="#full-pecan-xml-configuration-with-maat-options" class="anchor"></a>Full PEcAn XML configuration with MAAT options</h2>
<div id="e-g--pecan-xml-file-with-maat-configuration-options-" class="section level3">
<h3 class="hasAnchor">
<a href="#e-g--pecan-xml-file-with-maat-configuration-options-" class="anchor"></a>E.g. pecan.xml file with MAAT configuration options.</h3>
<p>In this example the MAAT model is configured for a temperate deciduous forest based on the temperate.deciduous PFT in the BETYdb database (<a href="https://www.betydb.org/pfts/2000000044" class="uri">https://www.betydb.org/pfts/2000000044</a>).</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;?xml</span> version="1.0"<span class="kw">?&gt;</span>
<span class="kw">&lt;pecan&gt;</span>
  <span class="kw">&lt;outdir&gt;</span>~/scratch/maat_pecan_test_run/<span class="kw">&lt;/outdir&gt;</span>
  
  <span class="kw">&lt;database&gt;</span>
    <span class="kw">&lt;bety&gt;</span>
      <span class="kw">&lt;driver&gt;</span>PostgreSQL<span class="kw">&lt;/driver&gt;</span>
      <span class="kw">&lt;user&gt;</span>bety<span class="kw">&lt;/user&gt;</span>
      <span class="kw">&lt;password&gt;</span>bety<span class="kw">&lt;/password&gt;</span>
      <span class="kw">&lt;host&gt;</span>localhost<span class="kw">&lt;/host&gt;</span>
      <span class="kw">&lt;dbname&gt;</span>bety<span class="kw">&lt;/dbname&gt;</span>
      <span class="kw">&lt;write&gt;</span>FALSE<span class="kw">&lt;/write&gt;</span>
     <span class="kw">&lt;/bety&gt;</span>
  <span class="kw">&lt;/database&gt;</span>

  <span class="kw">&lt;pfts&gt;</span>
    <span class="kw">&lt;pft&gt;</span>
      <span class="kw">&lt;name&gt;</span>temperate.deciduous<span class="kw">&lt;/name&gt;</span>
    <span class="kw">&lt;/pft&gt;</span>
  <span class="kw">&lt;/pfts&gt;</span>
  
  <span class="kw">&lt;meta.analysis&gt;</span>
    <span class="kw">&lt;iter&gt;</span>3000<span class="kw">&lt;/iter&gt;</span>
    <span class="kw">&lt;random.effects&gt;</span>FALSE<span class="kw">&lt;/random.effects&gt;</span>
    <span class="kw">&lt;threshold&gt;</span>1.2<span class="kw">&lt;/threshold&gt;</span>
    <span class="kw">&lt;update&gt;</span>TRUE<span class="kw">&lt;/update&gt;</span>
  <span class="kw">&lt;/meta.analysis&gt;</span>
  
  <span class="kw">&lt;ensemble&gt;</span>
      <span class="kw">&lt;size&gt;</span>10<span class="kw">&lt;/size&gt;</span>
      <span class="kw">&lt;variable&gt;</span>assimilation_rate<span class="kw">&lt;/variable&gt;</span>
  <span class="kw">&lt;/ensemble&gt;</span>
  
  <span class="kw">&lt;sensitivity.analysis&gt;</span>
      <span class="kw">&lt;quantiles&gt;</span>
          <span class="kw">&lt;sigma&gt;</span>-3<span class="kw">&lt;/sigma&gt;</span>
          <span class="kw">&lt;sigma&gt;</span>-2<span class="kw">&lt;/sigma&gt;</span>
          <span class="kw">&lt;sigma&gt;</span>-1<span class="kw">&lt;/sigma&gt;</span>
          <span class="kw">&lt;sigma&gt;</span>0<span class="kw">&lt;/sigma&gt;</span>
          <span class="kw">&lt;sigma&gt;</span>1<span class="kw">&lt;/sigma&gt;</span>
          <span class="kw">&lt;sigma&gt;</span>2<span class="kw">&lt;/sigma&gt;</span>
          <span class="kw">&lt;sigma&gt;</span>3<span class="kw">&lt;/sigma&gt;</span>
      <span class="kw">&lt;/quantiles&gt;</span>
      <span class="kw">&lt;variable&gt;</span>assimilation_rate<span class="kw">&lt;/variable&gt;</span>
  <span class="kw">&lt;/sensitivity.analysis&gt;</span>
  
  <span class="kw">&lt;model&gt;</span>
    <span class="kw">&lt;type&gt;</span>MAAT<span class="kw">&lt;/type&gt;</span>
      <span class="kw">&lt;id&gt;</span>2000000010<span class="kw">&lt;/id&gt;</span>
      <span class="kw">&lt;config&gt;</span>
        <span class="kw">&lt;mod_obj&gt;</span>leaf<span class="kw">&lt;/mod_obj&gt;</span>
        <span class="kw">&lt;leaf&gt;</span>
          <span class="kw">&lt;fnames&gt;</span>
            <span class="kw">&lt;vcmax&gt;</span>'f_vcmax_constant'<span class="kw">&lt;/vcmax&gt;</span>
            <span class="kw">&lt;jmax&gt;</span>'f_jmax_constant'<span class="kw">&lt;/jmax&gt;</span>
            <span class="kw">&lt;rd&gt;</span>'f_rd_constant'<span class="kw">&lt;/rd&gt;</span>
            <span class="kw">&lt;rs&gt;</span>'f_rs_ball1987'<span class="kw">&lt;/rs&gt;</span>
            <span class="kw">&lt;etrans&gt;</span>'f_j_farquharwong1984'<span class="kw">&lt;/etrans&gt;</span>
            <span class="kw">&lt;tcor_asc&gt;</span>
              <span class="kw">&lt;vcmax&gt;</span>'f_tcor_asc_Arrhenius'<span class="kw">&lt;/vcmax&gt;</span>
              <span class="kw">&lt;jmax&gt;</span>'f_tcor_asc_Arrhenius'<span class="kw">&lt;/jmax&gt;</span>
              <span class="kw">&lt;rd&gt;</span>'f_tcor_asc_Q10'<span class="kw">&lt;/rd&gt;</span>
              <span class="kw">&lt;tpu&gt;</span>'f_tcor_asc_Arrhenius'<span class="kw">&lt;/tpu&gt;</span>
            <span class="kw">&lt;/tcor_asc&gt;</span>
            <span class="kw">&lt;tcor_des&gt;</span>
              <span class="kw">&lt;vcmax&gt;</span>'f_tcor_des_modArrhenius'<span class="kw">&lt;/vcmax&gt;</span>
              <span class="kw">&lt;jmax&gt;</span>'f_tcor_des_modArrhenius'<span class="kw">&lt;/jmax&gt;</span>
              <span class="kw">&lt;rd&gt;</span>'f_tcor_des_cox2001'<span class="kw">&lt;/rd&gt;</span>
           <span class="kw">&lt;/tcor_des&gt;</span>
          <span class="kw">&lt;/fnames&gt;</span>
        <span class="kw">&lt;/leaf&gt;</span>
    <span class="kw">&lt;/config&gt;</span>
  <span class="kw">&lt;/model&gt;</span>
  
  <span class="kw">&lt;run&gt;</span>
    <span class="kw">&lt;site&gt;</span>
      <span class="kw">&lt;id&gt;</span>1000000146<span class="kw">&lt;/id&gt;</span>
        <span class="kw">&lt;met.start&gt;</span>2005/01/01<span class="kw">&lt;/met.start&gt;</span>
        <span class="kw">&lt;met.end&gt;</span>2006/12/31<span class="kw">&lt;/met.end&gt;</span>
     <span class="kw">&lt;/site&gt;</span>
      <span class="kw">&lt;inputs&gt;</span>
        <span class="kw">&lt;met&gt;</span>
          <span class="kw">&lt;source&gt;</span>AmerifluxLBL<span class="kw">&lt;/source&gt;</span>
            <span class="kw">&lt;output&gt;</span>MAAT<span class="kw">&lt;/output&gt;</span>
            <span class="kw">&lt;username&gt;</span>pecan<span class="kw">&lt;/username&gt;</span>
        <span class="kw">&lt;/met&gt;</span>
      <span class="kw">&lt;/inputs&gt;</span>
      <span class="kw">&lt;start.date&gt;</span>2005/01/01<span class="kw">&lt;/start.date&gt;</span>
      <span class="kw">&lt;end.date&gt;</span>2006/12/31<span class="kw">&lt;/end.date&gt;</span>
  <span class="kw">&lt;/run&gt;</span>
  
  <span class="kw">&lt;host&gt;</span>
    <span class="kw">&lt;name&gt;</span>localhost<span class="kw">&lt;/name&gt;</span>
  <span class="kw">&lt;/host&gt;</span>
  
<span class="kw">&lt;/pecan&gt;</span></code></pre></div>
</div>
</div>
<div id="simple-maat-run-in-pecan" class="section level2">
<h2 class="hasAnchor">
<a href="#simple-maat-run-in-pecan" class="anchor"></a>Simple MAAT run in PEcAn</h2>
<p>In this example we will run ten MAAT model ensembles in serial based on parameter values derived from the temperate.deciduous PFT in the BETYdb database (<a href="https://www.betydb.org/pfts/2000000044" class="uri">https://www.betydb.org/pfts/2000000044</a>) and the PEcAn meta analysis step</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(PEcAn.all)
<span class="kw">library</span>(PEcAn.utils)
<span class="kw">library</span>(RCurl)

<span class="kw">setwd</span>(<span class="st">"~"</span>)
<span class="kw">getwd</span>()
settings &lt;-<span class="st"> </span>PEcAn.settings<span class="op">::</span><span class="kw">read.settings</span>(<span class="kw">system.file</span>(<span class="st">"pecan.maat.xml"</span>, <span class="dt">package=</span><span class="st">"PEcAn.MAAT"</span>, <span class="dt">mustWork =</span> <span class="ot">TRUE</span>))
settings &lt;-<span class="st"> </span>PEcAn.settings<span class="op">::</span><span class="kw">prepare.settings</span>(settings, <span class="dt">force=</span><span class="ot">FALSE</span>)
PEcAn.logger<span class="op">::</span><span class="kw">logger.info</span>(<span class="kw">paste0</span>(<span class="st">"Main output directory: "</span>,settings<span class="op">$</span>outdir))

<span class="co"># Write pecan.CHECKED.xml</span>
PEcAn.settings<span class="op">::</span><span class="kw">write.settings</span>(settings, <span class="dt">outputfile =</span> <span class="st">"pecan.CHECKED.xml"</span>)

<span class="co"># start from scratch if no continue is passed in</span>
statusFile &lt;-<span class="st"> </span><span class="kw">file.path</span>(settings<span class="op">$</span>outdir, <span class="st">"STATUS"</span>)
<span class="cf">if</span> (<span class="kw">length</span>(<span class="kw">which</span>(<span class="kw">commandArgs</span>() <span class="op">==</span><span class="st"> "--continue"</span>)) <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">file.exists</span>(statusFile)) {
  <span class="kw">file.remove</span>(statusFile)
}

<span class="co"># Do conversions</span>
settings &lt;-<span class="st"> </span>PEcAn.utils<span class="op">::</span><span class="kw">do_conversions</span>(settings)

<span class="co"># Query the trait database for data and priors</span>
<span class="cf">if</span> (PEcAn.utils<span class="op">::</span><span class="kw">status.check</span>(<span class="st">"TRAIT"</span>) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){
  PEcAn.utils<span class="op">::</span><span class="kw">status.start</span>(<span class="st">"TRAIT"</span>)
  settings &lt;-<span class="st"> </span>PEcAn.workflow<span class="op">::</span><span class="kw">runModule.get.trait.data</span>(settings)
  PEcAn.settings<span class="op">::</span><span class="kw">write.settings</span>(settings, <span class="dt">outputfile=</span><span class="st">'pecan.TRAIT.xml'</span>)
  PEcAn.utils<span class="op">::</span><span class="kw">status.end</span>()
} <span class="cf">else</span> <span class="cf">if</span> (<span class="kw">file.exists</span>(<span class="kw">file.path</span>(settings<span class="op">$</span>outdir, <span class="st">'pecan.TRAIT.xml'</span>))) {
  settings &lt;-<span class="st"> </span>PEcAn.settings<span class="op">::</span><span class="kw">read.settings</span>(<span class="kw">file.path</span>(settings<span class="op">$</span>outdir, <span class="st">'pecan.TRAIT.xml'</span>))
}

<span class="co"># Run the PEcAn meta.analysis</span>
<span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(settings<span class="op">$</span>meta.analysis)) {
  <span class="cf">if</span> (PEcAn.utils<span class="op">::</span><span class="kw">status.check</span>(<span class="st">"META"</span>) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){
    PEcAn.utils<span class="op">::</span><span class="kw">status.start</span>(<span class="st">"META"</span>)
    PEcAn.MA<span class="op">::</span><span class="kw">runModule.run.meta.analysis</span>(settings)
    PEcAn.utils<span class="op">::</span><span class="kw">status.end</span>()
  }
}

<span class="co"># Write model specific configs</span>
<span class="cf">if</span> (PEcAn.utils<span class="op">::</span><span class="kw">status.check</span>(<span class="st">"CONFIG"</span>) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){
  PEcAn.utils<span class="op">::</span><span class="kw">status.start</span>(<span class="st">"CONFIG"</span>)
  settings &lt;-<span class="st"> </span>PEcAn.workflow<span class="op">::</span><span class="kw">runModule.run.write.configs</span>(settings)
  PEcAn.settings<span class="op">::</span><span class="kw">write.settings</span>(settings, <span class="dt">outputfile=</span><span class="st">'pecan.CONFIGS.xml'</span>)
  PEcAn.utils<span class="op">::</span><span class="kw">status.end</span>()
} <span class="cf">else</span> <span class="cf">if</span> (<span class="kw">file.exists</span>(<span class="kw">file.path</span>(settings<span class="op">$</span>outdir, <span class="st">'pecan.CONFIGS.xml'</span>))) {
  settings &lt;-<span class="st"> </span>PEcAn.settings<span class="op">::</span><span class="kw">read.settings</span>(<span class="kw">file.path</span>(settings<span class="op">$</span>outdir, <span class="st">'pecan.CONFIGS.xml'</span>))
}

<span class="co"># Start MAAT model runs</span>
<span class="cf">if</span> (PEcAn.utils<span class="op">::</span><span class="kw">status.check</span>(<span class="st">"MODEL"</span>) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
  PEcAn.utils<span class="op">::</span><span class="kw">status.start</span>(<span class="st">"MODEL"</span>)
  PEcAn.remote<span class="op">::</span><span class="kw">runModule.start.model.runs</span>(settings,<span class="dt">stop.on.error=</span><span class="ot">FALSE</span>)
  PEcAn.utils<span class="op">::</span><span class="kw">status.end</span>()
}

PEcAn.logger<span class="op">::</span><span class="kw">logger.info</span>(<span class="st">"*** Wait for model runs to finish. Since this is a serial execution of MAAT, it will take a few minutes ***"</span>)

<span class="co"># Get results of model runs</span>
<span class="cf">if</span> (PEcAn.utils<span class="op">::</span><span class="kw">status.check</span>(<span class="st">"OUTPUT"</span>) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
  PEcAn.utils<span class="op">::</span><span class="kw">status.start</span>(<span class="st">"OUTPUT"</span>)
  <span class="kw">runModule.get.results</span>(settings)
  PEcAn.utils<span class="op">::</span><span class="kw">status.end</span>()
}

<span class="co"># Run ensemble analysis on model output.</span>
<span class="cf">if</span> (<span class="st">'ensemble'</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(settings) <span class="op">&amp;</span><span class="st"> </span>PEcAn.utils<span class="op">::</span><span class="kw">status.check</span>(<span class="st">"ENSEMBLE"</span>) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
  PEcAn.utils<span class="op">::</span><span class="kw">status.start</span>(<span class="st">"ENSEMBLE"</span>)
  <span class="kw">runModule.run.ensemble.analysis</span>(settings, <span class="ot">TRUE</span>)
  PEcAn.utils<span class="op">::</span><span class="kw">status.end</span>()
}

<span class="co"># Pecan workflow complete</span>
<span class="cf">if</span> (PEcAn.utils<span class="op">::</span><span class="kw">status.check</span>(<span class="st">"FINISHED"</span>) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
  PEcAn.utils<span class="op">::</span><span class="kw">status.start</span>(<span class="st">"FINISHED"</span>)
  PEcAn.remote<span class="op">::</span><span class="kw">kill.tunnel</span>(settings)
  <span class="kw">db.query</span>(<span class="kw">paste</span>(<span class="st">"UPDATE workflows SET finished_at=NOW() WHERE id="</span>, settings<span class="op">$</span>workflow<span class="op">$</span>id, <span class="st">"AND finished_at IS NULL"</span>), <span class="dt">params=</span>settings<span class="op">$</span>database<span class="op">$</span>bety)

  <span class="co"># Send email if configured</span>
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(settings<span class="op">$</span>email) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.null</span>(settings<span class="op">$</span>email<span class="op">$</span>to) <span class="op">&amp;&amp;</span><span class="st"> </span>(settings<span class="op">$</span>email<span class="op">$</span>to <span class="op">!=</span><span class="st"> ""</span>)) {
    <span class="kw"><a href="http://www.rdocumentation.org/packages/PEcAn.utils/topics/sendmail">sendmail</a></span>(settings<span class="op">$</span>email<span class="op">$</span>from, settings<span class="op">$</span>email<span class="op">$</span>to,
             <span class="kw">paste0</span>(<span class="st">"Workflow has finished executing at "</span>, base<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/base/topics/date">date</a></span>()),
             <span class="kw">paste0</span>(<span class="st">"You can find the results on "</span>, settings<span class="op">$</span>email<span class="op">$</span>url))
  }
  PEcAn.utils<span class="op">::</span><span class="kw">status.end</span>()
}

<span class="kw">db.print.connections</span>()
<span class="kw">print</span>(<span class="st">"---------- PEcAn Workflow Complete ----------"</span>)

<span class="kw">print</span>(<span class="st">" "</span>)
<span class="kw">print</span>(<span class="st">" "</span>)

<span class="kw">print</span>(<span class="st">"---------- Simple ensemble plot ----------"</span>)
<span class="co"># create a simple timeseries plot of the ensemble output</span>

<span class="co"># get output and calculate some stats</span>
ensemble_output &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> settings<span class="op">$</span>outdir, <span class="dt">pattern =</span> <span class="st">"ensemble.ts.NOENSEMBLEID.*Rdata"</span>)
<span class="kw">load</span>(<span class="kw">file.path</span>(settings<span class="op">$</span>outdir,ensemble_output))
timeseries_stats &lt;-<span class="st"> </span><span class="kw">apply</span>(ensemble.ts<span class="op">$</span>assimilation_rate,<span class="dv">2</span>,quantile,<span class="dt">probs=</span><span class="kw">c</span>(<span class="fl">0.025</span>,<span class="fl">0.5</span>,<span class="fl">0.975</span>))

<span class="co"># create timeseries X axis</span>
x_axis &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">as.Date</span>(settings<span class="op">$</span>run<span class="op">$</span>start.date), <span class="kw">as.Date</span>(settings<span class="op">$</span>run<span class="op">$</span>end.date), <span class="dt">length.out=</span><span class="kw">dim</span>(timeseries_stats)[<span class="dv">2</span>])

<span class="co"># create a new plot window</span>
<span class="kw">dev.new</span>(<span class="dt">width=</span><span class="dv">14</span>, <span class="dt">height=</span><span class="dv">8</span>, <span class="dt">unit=</span><span class="st">"in"</span>)

<span class="co"># create plot</span>
<span class="kw">plot</span>(x_axis, PEcAn.utils<span class="op">::</span><span class="kw">misc.convert</span>(timeseries_stats[<span class="dv">2</span>,],<span class="st">"kg C m-2 s-1"</span>,<span class="st">"umol C m-2 s-1"</span>), <span class="dt">type=</span><span class="st">"l"</span>,<span class="dt">cex=</span><span class="fl">0.00001</span>, <span class="dt">col=</span><span class="st">"white"</span>,
     <span class="dt">xlab=</span><span class="st">"Time"</span>, <span class="dt">ylab=</span><span class="st">"Assimilation_rate (umol/m2/s)"</span>)
<span class="kw">polygon</span>(<span class="kw">c</span>(x_axis ,<span class="kw">rev</span>(x_axis)),<span class="kw">c</span>(PEcAn.utils<span class="op">::</span><span class="kw">misc.convert</span>(timeseries_stats[<span class="dv">3</span>,],<span class="st">"kg C m-2 s-1"</span>,<span class="st">"umol C m-2 s-1"</span>), 
                                 <span class="kw">rev</span>(PEcAn.utils<span class="op">::</span><span class="kw">misc.convert</span>(timeseries_stats[<span class="dv">1</span>,],<span class="st">"kg C m-2 s-1"</span>,<span class="st">"umol C m-2 s-1"</span>))),
        <span class="dt">col=</span><span class="st">"#99CC99"</span>,<span class="dt">border=</span><span class="st">"#99CC99"</span>)
<span class="kw">lines</span>(x_axis,PEcAn.utils<span class="op">::</span><span class="kw">misc.convert</span>(timeseries_stats[<span class="dv">2</span>,],<span class="st">"kg C m-2 s-1"</span>,<span class="st">"umol C m-2 s-1"</span>),<span class="dt">lwd=</span><span class="dv">1</span>, <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">col=</span><span class="st">"light grey"</span>)

<span class="co"># close plot</span>
<span class="kw">dev.off</span>()</code></pre></div>
<p>Example output MAAT assimilation rate from the five PEcAn model esemble simulations. The green shaded area represents the ensemble spread and the grey line shows the mean simulation.</p>
<div class="figure">
<img src="graphics/example_assimilation_rate.png" alt="Example output MAAT assimilation rate from the five PEcAn model esemble simulations"><p class="caption">Example output MAAT assimilation rate from the five PEcAn model esemble simulations</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#overview">Overview</a><ul class="nav nav-pills nav-stacked">
<li><a href="#maat-installation-and-usage">MAAT Installation and usage</a></li>
      <li><a href="#installing-the-r-packages">Installing the R packages</a></li>
      <li><a href="#maat-xml-configuration">MAAT XML configuration</a></li>
      <li><a href="#full-pecan-xml-configuration-with-maat-options">Full PEcAn XML configuration with MAAT options</a></li>
      <li><a href="#simple-maat-run-in-pecan">Simple MAAT run in PEcAn</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Shawn Serbin, Anthony Walker.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
