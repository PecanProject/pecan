##-------------------------------------------------------------------------------
## Copyright (c) 2012 University of Illinois, NCSA.
## All rights reserved. This program and the accompanying materials
## are made available under the terms of the 
## University of Illinois/NCSA Open Source License
## which accompanies this distribution, and is available at
## http://opensource.ncsa.illinois.edu/license.html
##-------------------------------------------------------------------------------
##--------------------------------------------------------------------------------------------------#
##' Convert BioCro output to netCDF
##'
##' Converts BioCro output to netCDF.
##' Modified from on model2netcdf.sipnet and model2netcdf.ED2 by
##' Shawn Serbin and Mike Dietze
##' @name model2netcdf.BIOCRO
##' @title Function to convert biocro model output to standard netCDF format
##' @param resultDT output from BioCro model
##' @param outdir Location of model output
##' @param lat Latitude of the site
##' @param lon Longitude of the site
##' @export
##'
##' @author David LeBauer, Deepak Jaiswal
model2netcdf.BIOCRO <- function(resultDT, outdir, lat = NULL, lon = NULL) {

    if(is.null(lat)) lat <- resultDT$lat
    if(is.null(lat)) lon <- resultDT$lon
  require(lubridate, quietly = TRUE)
  require(data.table, quietly = TRUE)
  start.date <- resultDT[1, ymd_hms(paste0(Year, "-01-01 ", Hour, ":00:00")) + days(DayofYear - 1)]
    ## Read in model output in biocro format
    load(file.path(outdir, "result.RData")) ## contains genus and result
    for(yeari in unique(resultDT$Year)) {
        result <- resultDT[resultDT$Year == yeari,]
        ##result$s <- with(result, ((DayofYear -1) * 24 + Hour) * 3600)
        if(exists('genus')){
            if(genus == "Saccharum"){
                for(variable in c("Leaf", "Root", "Stem", "LAI", "DayofYear")) {
                    x <- result[[variable]]
                    result[[variable]] <- c(x[1], rep(x[-1], 24, each = TRUE))
                }
            }
        }
        
        ## longname prefix station_* used for a point
        ## http://cf-pcmdi.llnl.gov/documents/cf-conventions/1.4/cf-conventions.html#scalar-coordinate-variables
        lat <- ncdim_def("lat", "degrees_east",
                         vals =  as.numeric(lat),
                         longname = "station_latitude") 
        lon <- ncdim_def("lon", "degrees_north",
                         vals = as.numeric(lon),
                         longname = "station_longitude")
        t <- ncdim_def(name = "time",
                       units = paste0("days since ", start.date),
                       vals = with(result, DayofYear + Hour/24),
                       calendar = "standard", unlim = TRUE)
        ## seconds per day
        vars <- list()
        
        c2biomass <- 0.4
        vars <- list(
            TotLivBiom  = mstmipvar("TotLivBiom", lat, lon, t),
            RootBiom    = mstmipvar("RootBiom", lat, lon, t),
            StemBiom    = mstmipvar("StemBiom", lat, lon, t),
            Evap        = mstmipvar("Evap", lat, lon, t),
            TVeg        = mstmipvar("TVeg", lat, lon, t),
            LAI         = mstmipvar("LAI", lat, lon, t))
        
        k <- ud.convert(1, "Mg/ha", "kg/m2") / c2biomass
        
        results <- with(result, list(
            TotLivBiom = k * (Leaf + Root + Stem + Rhizome + Grain),
            RootBiom = k * Root,
            StemBiom = k * Stem,
            Evap = ud.convert(SoilEvaporation + CanopyTrans, "Mg/ha/h", "kg/m2/s"),
            TVeg = ud.convert(CanopyTrans, "Mg/ha/h", "kg/m2/s"),
            LAI =  LAI))
        
        nc <- nc_create(filename = file.path(outdir, paste0(yeari, ".nc")),
                        vars = vars)
        varfile <- file(file.path(outdir, paste(yeari, "nc", "var", sep=".")), "w")
        
        ## Output netCDF data
        for(.vname in names(vars)) {
                                        # make sure only floats are in array
            x <- which(results[[.vname]]< -1e100)
            if (length(x) > 0) {
                logger.debug(.vname, "found", length(x), "values < -1e100")
                results[[.vname]][[x]] <- NA  
            }
            x <- which(results[[.vname]] > 1e100)
            if (length(x) > 0) {
                logger.debug(.vname, "found", length(x), "values > 1e100")
                results[[.vname]][[x]] <- NA  
            }
                                        # write results
            ncvar_put(nc, varid = vars[[.vname]], vals = results[[.vname]])
            cat(paste(vars[[.vname]]$name, vars[[.vname]]$longname), file=varfile, sep="\n")
        }
        
        ncatt_put(nc, 0, "description",
                  "This is an output from the BioCro Crop model generated by the model2netcdf.BIOCRO.R function in the PEcAn.BIOCRO package; see github.com:PecanProject/pecan/wiki for more information")
        close(varfile)
        nc_close(nc)
    } ## end loop over years
}

####################################################################################################
### EOF.  End of R script file.              
####################################################################################################
