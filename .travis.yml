# Follow instructions on:
# https://blog.rstudio.org/2016/03/09/r-on-travis-ci/

language: r
r:
  - release
  - devel
  - oldrel

# TRUSTY: Change version when 16.04 image is available.
dist: xenial
sudo: required

env:
  global:
    # TODO: `make -j2` interleaves output lines from simultaneous processes.
    # Would be nice to fix by adding `-Otarget`, but not supported in Make 3.x.
    # When Travis updates, check for Make 4 and add -O if available.
    - MAKEFLAGS="-j2"
    - PGHOST=localhost
    - RGL_USE_NULL=TRUE # Keeps RGL from complaining it can't find X11

matrix:
  fast_finish: true
  allow_failures:
    - r: devel
    - r: oldrel

cache: 
  - directories:
    - .install
    - .check
    - .test
    - .doc
  - packages

addons:
  apt:
    packages:
      # - jags
      # - time
      # - libgdal-dev
      # - librdf0-dev
      # - libnetcdf-dev
      # - libudunits2-dev
      # - libgl1-mesa-dev
      # - libglu1-mesa-dev
      # r-cran binary packages

## notifications should go to slack
notifications:
  slack:
    # Slack token created by Chris Black, 2018-02-17
    secure: "DHHSNmiCf71SLa/FFSqx9oOnJjJt2GHYk7NsFIBb9ZY10RvQtIPfaoNxkPjqu9HLyZWJSFtg/uNKKplEHc6W80NoXyqoTvwOxTPjMaViXaCNqsmzjjR/JaCWT/oWGXyAw0VX3S8cwuIexlKQGgZwJpIzoVOZqUrDrHI/O17kZoM="
  email:
    on_success: always
    on_failure: always

## list of services to be running
services:
  - docker

install:
  - scripts/travis/install.sh
  
before_script:
  - scripts/travis/before_script.sh
#   - docker run --detach --rm --name postgresql --publish 5432:5432 mdillon/postgis:9.6-alpine
#   - echo -n "Waiting for Postgres to start...";
#     until psql -U postgres -c 'select 1' >/dev/null 2>&1;
#       do echo -n ".";
#       sleep 1;
#     done;
#     echo " OK"
#   - psql -q -o /dev/null -U postgres -c "CREATE ROLE BETY WITH LOGIN CREATEDB SUPERUSER CREATEROLE UNENCRYPTED PASSWORD 'bety'";
#   - psql -q -o /dev/null -U postgres -c "CREATE DATABASE bety OWNER bety;"
#   - curl -o bety.sql http://isda.ncsa.illinois.edu/~kooper/PEcAn/data/bety.sql
#   - psql -q -o /dev/null -U postgres < bety.sql
#   - rm bety.sql
#   - ./scripts/add.models.sh
#   - chmod +x book_source/deploy.sh
#   - chmod +x documentation/tutorials/deploy.sh

script:
  - scripts/travis/script.sh

# after_script:
#   - set -e
#   - echo 'Building Book'
#   - pushd book_source
#   - make
#   - popd
#   - echo 'Building Tutorials'
#   - pushd documentation/tutorials
#   - make build deploy
#   - popd
#   - set +e
