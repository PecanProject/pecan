<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>Module Documentation</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style>
body { font:80% Verdana,Tahoma,Arial,sans-serif; }
h1, h2, h3, h4 {  font-family: "Trebuchet MS",Georgia,"Times New Roman",serif; }
ul.toc { padding: 4px; margin-left: 0; }
ul.toc li { list-style-type:none; }
ul.toc li.heading2 { margin-left: 1em; }
ul.toc li.heading3 { margin-left: 2em; }
a.wiki-anchor { display: none; margin-left: 6px; text-decoration: none; }
a.wiki-anchor:hover { color: #aaa !important; text-decoration: none; }
h1:hover a.wiki-anchor, h2:hover a.wiki-anchor, h3:hover a.wiki-anchor { display: inline; color: #ddd; }
</style>
</head>
<body>
<ul class="toc"><li><a href="#Module-Definitions">Module Definitions</a><ul><li><a href="#Query-BETY">Query BETY</a></li><li><a href="#Meta-Analysis">Meta Analysis</a></li><li><a href="#Single-Write-Config">Single Write Config</a></li><li><a href="#Write-Configs">Write Configs</a></li><li><a href="#Start-Runs">Start Runs</a></li><li><a href="#Read-Model-output">Read Model output</a></li><li><a href="#Sensitivity-Analysis">Sensitivity Analysis</a></li><li><a href="#Variance-Decomposition">Variance Decomposition</a></li><li><a href="#Visualization">Visualization</a></li></ul>
</li><li><a href="#Glossary">Glossary</a></li></ul>


	<a name="Module-Definitions"></a>
<h1 >Module Definitions<a href="#Module-Definitions" class="wiki-anchor">&para;</a></h1>


	<p>In all cases pecan/bash/scriptname.sh calls pecan/rscripts/scriptname.R. These script pairs represent workflow modules.</p>


	<a name="Query-BETY"></a>
<h2 >Query BETY<a href="#Query-BETY" class="wiki-anchor">&para;</a></h2>


	<ul>
	<li>name: query.bety.R</li>
		<li>Description: extracts prior distributions for specified pfts, and trait data for any species associated with pft </li>
		<li>Parameters:
	<ul>
	<li>settings file: xml file containing inputs
	<ul>
	<li>settings$database: database connection information</li>
		<li>pft$name: name of pft used to link to BETY database pfts table, and to query species from BETY </li>
		<li>pft$constants: fixed parameter values </li>
	</ul>
	</li>
	</ul>
	</li>
		<li>Inputs:
	<ul>
	<li>from BETY:
	<ul>
	<li>spstr: string of comma delimited, specie_id values in quotes. Used to query trait data associated with these species. These are the species linked to pft$name by the pfts_species table</li>
		<li>prior.distns: table of prior distributions. These are used in the meta-analysis. These are queried from the priors table, and are selected by linking the settings pft$name to pfts.name in the database, which is linked to the priors table by the pfts_priors lookup table.</li>
	</ul>
	</li>
	</ul>
	</li>
		<li>Outputs:
	<ul>
	<li>trait.data.Rdata: list 'trait.data', containing one table per trait. Used in Meta Analysis. Tables have columns Y, n, site, trt, ghs, obs.prec, se, and cite. These columns are derived from bety using the query.bety.trait.data function with the following relationships: Y = traits.mean, n = traits.n, site = traits.site_id, trt = traits.treatment_id, ghs = treatments.greenhouse, obs.prec = f(se), se = f(traits.stat, traits.statname), and cite = citation_id. the site, trt, and ghs values in the database have been converted to sequential integers starting at 1. Each row is a separate observation</li>
		<li>prior.distns.Rdata: Used in Meta Analysis tables of prior distributions for each pft, one row per trait, with columns distn, parama, paramb, and n. distn is the name of one of the probability distributions supported by R (commonly gamma, beta, lognorm, weibull, norm), parama and paramb are the first and second parameters of the distribution.</li>
	</ul></li>
	</ul>


	<a name="Meta-Analysis"></a>
<h2 >Meta Analysis<a href="#Meta-Analysis" class="wiki-anchor">&para;</a></h2>


	<ul>
	<li>name: meta.analysis.R</li>
		<li>Description: calculates the posterior distribution of for traits for each pft, where there exist species-level data for the given pft x trait combination. </li>
		<li>Parameters:
	<ul>
	<li>settings file
	<ul>
	<li>meta.analysis$iter: number of steps in MCMC chain</li>
		<li>pft$outdir: directory for pft-specific output</li>
		<li>pft$name: name of pft</li>
	</ul>
	</li>
	</ul>
	</li>
		<li>Inputs:
	<ul>
	<li>trait.data.Rdata: Generated by Query BETY module. Data tables for each trait by species combination</li>
		<li>prior.distns.Rdata: Generated by Query BETY module. Tables of prior distributions for each pft</li>
	</ul>
	</li>
		<li>Outputs:
	<ul>
	<li>&lt;traitname&gt;.model.bug meta-analysis model specification in JAGS (used internally) </li>
		<li>trait.mcmc.Rdata: To be used by Write Configs. List of raw mcmc output (of class mcmc.list) with one mcmc.list per trait  </li>
		<li>post.distns.Rdata: To be used in data assimilation (not currently implemented). Posterior distributions for each pft/trait combination summarized using standard distributions</li>
		<li>meta.analysis.log:  for human assessment: data, meta-analysis results, MCMC diagnostics (also written to terminal)</li>
		<li>ma.summaryplots.&lt;site&gt;.&lt;pft&gt;&lt;trait&gt;.pdf: for human assessment: diagnostic plots, to check that convergence meets assumptions of MCMC method</li>
		<li>posteriors.pdf: for human assessment of meta-analysis and data: plots for comparing posterior with data and prior</li>
	</ul></li>
	</ul>


	<a name="Single-Write-Config"></a>
<h2 >Single Write Config<a href="#Single-Write-Config" class="wiki-anchor">&para;</a></h2>


	<p>A single configuration file can be written using the write.config() function, e.g.:</p>


<pre>
trait.samples &lt;- list(Vcmax = 20, SLA = 20)
settings &lt;- xmlToList(xmlParse('~/test.pecan/settings.xml'))
pft &lt;- settings$pfts[[1]]
outdir &lt;- settings$outdir
run.id &lt;- 'test.run'
write.config.ED(pft, trait.samples, settings, outdir, run.id) 
</pre> 

	<a name="Write-Configs"></a>
<h2 >Write Configs<a href="#Write-Configs" class="wiki-anchor">&para;</a></h2>


	<ul>
	<li>name: write.configs.R</li>
		<li>Description: writes configuration files used in the model runs. Model specific unit and naming conversions are made using functions found in R/model.specific.R</li>
		<li>Parameters:
	<ul>
	<li>settings file
	<ul>
	<li>pft$name</li>
		<li>pft$outdir</li>
		<li>settings$ensemble</li>
		<li>settings$sensitivity.analysis</li>
		<li>settings$sensitivity.analysis$quantiles</li>
	</ul>
	</li>
		<li>&lt;runid&gt; is a function of either quantiles or i=1:n ensemble members </li>
		<li>ED2IN template (see edin/templateED2IN*)</li>
	</ul>
	</li>
		<li>Inputs:
	<ul>
	<li>prior.distns.Rdata (from Meta Analysis)</li>
		<li>trait.mcmc.Rdata (from Meta Analysis)</li>
	</ul>
	</li>
		<li>Outputs:
	<ul>
	<li>ED2INc.&lt;pft&gt;&lt;runid&gt; ED2IN file for each run</li>
		<li>c.&lt;pft&gt;&lt;runid&gt;  configuration file for each run</li>
	</ul>
	</li>
		<li>Side Effects:
	<ul>
	<li>Deletes existing config files prior to writing new ones</li>
	</ul></li>
	</ul>


	<a name="Start-Runs"></a>
<h2 >Start Runs<a href="#Start-Runs" class="wiki-anchor">&para;</a></h2>


	<p>(works on 1 or more runs)</p>


	<ul>
	<li>name: start.runs.R</li>
		<li>Description: Starts model runs by executing bash/batch.jobs.sh</li>
		<li>Parameters:
	<ul>
	<li>settings file
	<ul>
	<li>host$name: machine with model</li>
		<li>host$rundir: directory where model executable is located</li>
		<li>settings$pecanDir pecan home directory where bash/batch.jobs.sh resides</li>
	</ul>
	</li>
	</ul>
	</li>
		<li>Inputs:
	<ul>
	<li>ED2INc.&lt;pft&gt;&lt;runid&gt; ED2IN file for each run (from Write Configs)</li>
		<li>c.&lt;pft&gt;&lt;runid&gt;  configuration file for each run (from Write Configs) </li>
		<li>batch.jobs.sh: script that starts a run for each ED2IN* file generated in write.configs</li>
	</ul>
	</li>
		<li>Outputs:
	<ul>
	<li>ED Model output for each &lt;runid&gt;</li>
	</ul></li>
	</ul>


	<a name="Read-Model-output"></a>
<h2 >Read Model output<a href="#Read-Model-output" class="wiki-anchor">&para;</a></h2>


	<ul>
	<li>works for one or more runs, currently set to only output AGB</li>
		<li>see read.output.R for code used to extract data from ED on cluster</li>
	</ul>


	<ul>
	<li>name: get.model.output.R</li>
		<li>Description</li>
		<li>Parameters:
	<ul>
	<li>settings file
	<ul>
	<li>settings$run$host name of model host machine</li>
		<li>settings$outdir directory in which output should be saved</li>
	</ul>
	</li>
	</ul>
	</li>
		<li>Inputs:
	<ul>
	<li>read.output.R script with functions and code to extract model output (self contained, so it can be executed independently on model host machine)</li>
	</ul>
	</li>
		<li>Output
	<ul>
	<li>ensemble.Rdata, to be used, e.g., in Sensitivity Analysis and Visualization modules containing (if produced):
	<li>sensitivity.Rdata, to be used, e.g., in Sensitivity Analysis and Visualization modules containing (if produced):
	<ul>
	<li>ensemble.output: results from ensemble runs</li>
		<li>sa.output: aboveground bioma</li>
	</ul>
	</li>
	</ul>
	</li>
		<li>name: get.model.output.R</li>
		<li>Description</li>
		<li>Parameters:
	<ul>
	<li>settings file
	<ul>
	<li>settings$run$host name of model host machine</li>
		<li>settings$outdir directory in which output should be saved</li>
	</ul>
	</li>
	</ul>
	</li>
		<li>Inputs:
	<ul>
	<li>read.output.R script with functions and code to extract model output (self contained, so it can be executed independently on model host machine)</li>
	</ul>
	</li>
		<li>Output
	<ul>
	<li>sensitivity.Rdata, to be used, e.g., in Sensitivity Analysis and Visualization modules containing (if produced):
	<li>ensemble.Rdata, to be used, e.g., in Sensitivity Analysis and Visualization modules containing (if produced):
	<ul>
	<li>ensemble.output: results from ensemble runs</li>
		<li>sa.output: aboveground biomass results from sensitivity runsss results from sensitivity runs</li>
	</ul></li>
	</ul></li>
	</ul>


	<a name="Sensitivity-Analysis"></a>
<h2 >Sensitivity Analysis<a href="#Sensitivity-Analysis" class="wiki-anchor">&para;</a></h2>


	<ul>
	<li>in the context of modularization, this script is still under development</li>
	</ul>


	<a name="Variance-Decomposition"></a>
<h2 >Variance Decomposition<a href="#Variance-Decomposition" class="wiki-anchor">&para;</a></h2>


	<ul>
	<li>to be branched from Sensitivity Analysis module</li>
	</ul>


	<a name="Visualization"></a>
<h2 >Visualization<a href="#Visualization" class="wiki-anchor">&para;</a></h2>


	<ul>
	<li>under development, will be partially branched from current Sensitivity Analysis module</li>
	</ul>


	<a name="Glossary"></a>
<h1 >Glossary<a href="#Glossary" class="wiki-anchor">&para;</a></h1>


	<ul>
	<li>Inputs: data sets that are used, and file paths leading to them</li>
		<li>Parameters: e.g. info set in settings file </li>
		<li>Outputs: data sets that are dropped, and the file paths leading to them</li>
	</ul>
</body>
</html>
