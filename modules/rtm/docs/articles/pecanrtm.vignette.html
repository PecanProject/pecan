<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The PEcAn RTM package • PEcAnRTM</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="The PEcAn RTM package">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PEcAnRTM</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.6.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/pecanrtm.vignette.html">The PEcAn RTM package</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>The PEcAn RTM package</h1>
                        <h4 class="author">Alexey Shiklomanov</h4>
            
      
      
      <div class="hidden name"><code>pecanrtm.vignette.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The PEcAnRTM package provides tools for analyses involving common radiative transfer models. The highlights of this package are its ability to efficiently run a suite of related leaf and canopy radiative transfer models, as well as to perform maximum likelihood and, particularly, Bayesian inversions of these models.</p>
</div>
<div id="installation" class="section level1">
<h1 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h1>
<p>The easiest way to install this package is via <code>install_github</code> from the <code>devtools</code> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">"devtools"</span>)
<span class="kw">library</span>(devtools)
<span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"ashiklom/pecan"</span>, <span class="dt">subdir =</span> <span class="st">"modules/rtm"</span>)
<span class="co"># Defaults to branch 'master'. </span>
<span class="co"># For custom branches, add `ref = "branchname"`</span></code></pre></div>
<p>This package relies on a modern (&gt;= 2003) Fortran compiler, as determined by your R installation. On most Unix systems, this is standard, but R may specify a particular compiler version that you don’t have, resulting in an installation error. To fix this, simply add the following to your system <code>~/R/Makevars</code> file.</p>
<pre><code>FC = gfortran</code></pre>
</div>
<div id="overview-of-features" class="section level1">
<h1 class="hasAnchor">
<a href="#overview-of-features" class="anchor"></a>Overview of features</h1>
<div id="simulating-reflectance" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-reflectance" class="anchor"></a>Simulating reflectance</h2>
<p>Available radiative transfer models are called by passing a vector of their parameters. Similar models with different versions (e.g. PROSPECT 4, 5, 5B) also have a “version” argument. These models return a matrix of reflectance, transmittance, and/or absorption spectra (depending on the model) at 1 nm resolution over the wavelength range 400 to 2500 nm.</p>
<p>The PROSPECT family of models returns the reflectance (column 1) and transmittance (column 2) for an individual leaf as a function of 4 to 6 parameters (depending on the version).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(PEcAnRTM)
wl &lt;-<span class="st"> </span><span class="dv">400</span><span class="op">:</span><span class="dv">2500</span>
params &lt;-<span class="st"> </span><span class="kw">c</span>(
  <span class="st">"N"</span> =<span class="st"> </span><span class="fl">1.4</span>, <span class="st">"Cab"</span> =<span class="st"> </span><span class="dv">40</span>, <span class="st">"Car"</span> =<span class="st"> </span><span class="dv">15</span>,
  <span class="st">"Cbrown"</span> =<span class="st"> </span><span class="fl">0.5</span>, <span class="st">"Cw"</span> =<span class="st"> </span><span class="fl">0.002</span>, <span class="st">"Cm"</span> =<span class="st"> </span><span class="fl">0.004</span>
)

p4 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prospect.html">prospect</a></span>(params[<span class="kw">c</span>(<span class="op">-</span><span class="dv">3</span>, <span class="op">-</span><span class="dv">4</span>)], <span class="dt">version =</span> <span class="dv">4</span>)
p4</code></pre></div>
<p>Notice only the first and last few lines of the spectra are printed, and the wavelength is annotated on the side. This is is because all RTM simulations in this package are of a special matrix class <code>spectra</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(p4)</code></pre></div>
<p>This class allows traditional subsetting via index with single brackets (<code>[]</code>), as well as subsetting by wavelength with double brackets.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p4[<span class="dv">1</span><span class="op">:</span><span class="dv">50</span>, <span class="dv">1</span>]
p4[[<span class="dv">500</span><span class="op">:</span><span class="dv">520</span>, <span class="dv">2</span>]]</code></pre></div>
<p>The package also provides special plotting (<code>plot</code>, <code>matplot</code>) and combining (<code>cbind</code>) methods. Note that the <code>cbind</code> method automatically matches wavelengths, which facilitates working with spectra with different wavelengths.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p5 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prospect.html">prospect</a></span>(params[<span class="op">-</span><span class="dv">4</span>], <span class="dt">version =</span> <span class="dv">5</span>)
p5b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prospect.html">prospect</a></span>(params, <span class="dt">version =</span> <span class="st">"5B"</span>)
p_multi &lt;-<span class="st"> </span><span class="kw">cbind</span>(p4, p5, p5b)
<span class="kw"><a href="../reference/matplot.html">matplot</a></span>(p_multi[, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>)], <span class="dt">lty =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">col =</span> <span class="dv">2</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))
<span class="kw"><a href="../reference/matplot.html">matplot</a></span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p_multi[, <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>)], <span class="dt">lty =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">col =</span> <span class="dv">3</span>,  <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw">legend</span>(<span class="st">"topright"</span>, <span class="kw">c</span>(<span class="st">"Reflectance"</span>, <span class="st">"Transmittance"</span>), <span class="dt">col=</span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="dt">lty =</span> <span class="dv">1</span>)
<span class="kw">legend</span>(<span class="st">"top"</span>, <span class="kw">c</span>(<span class="st">"4"</span>, <span class="st">"5"</span>, <span class="st">"5B"</span>), <span class="dt">lty =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</code></pre></div>
<p>The SAIL family of models returns the bidirectional (1), hemispherical directional (2), directional hemispherical (3), and bidirectional hemispherical (4) reflectance factors for a canopy with a given set of approximately 20 parameters. It is often coupled to the PROSPECT model as PRO4SAIL. (Again, note that the return type is a <code>spectra</code>, which leads <code>matplot</code> to automatically put wavelengths on the x axis.)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sail.params &lt;-<span class="st"> </span><span class="kw"><a href="../reference/defparam.html">defparam</a></span>(<span class="st">"pro4sail"</span>)
<span class="kw">print</span>(sail.params)
p4s &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pro4sail.html">pro4sail</a></span>(sail.params)
<span class="kw"><a href="../reference/matplot.html">matplot</a></span>(p4s, <span class="dt">xlab=</span><span class="st">"Wavelength (nm)"</span>, <span class="dt">ylab=</span><span class="st">"Reflectance"</span>)
<span class="kw">legend</span>(<span class="st">"topright"</span>, <span class="kw">as.character</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>), <span class="dt">col=</span><span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">lty=</span><span class="dv">1</span><span class="op">:</span><span class="dv">4</span>)</code></pre></div>
<p>The above example illustrates the use of <code>defparam</code> to get the default parameters for a particular model. Similarly, <code>model.list</code> is a <code>data.frame</code> containing all currently available models.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(model.list)</code></pre></div>
</div>
<div id="inversion" class="section level2">
<h2 class="hasAnchor">
<a href="#inversion" class="anchor"></a>Inversion</h2>
<p>A novel feature of this package is the ability to perform a Bayesian inversion of a Radiative Transfer Model. Here are several advantages of the Bayesian approach:</p>
<ul>
<li>
<strong>Parameter uncertainty:</strong> The output of a Bayesian analysis is a full joint probability distribution of the model parameters, which includes a robust estimate of their uncertainy and covariance between parameters.</li>
<li>
<strong>Prior knowledge:</strong> If previous, independent estimates of parameters are available, these can be used to inform the model.</li>
<li>
<strong>Partitioning variability:</strong> Random effects models provide a powerful framework for understanding the sources of variability and uncertainty in a data set.</li>
</ul>
<p>An inversion can be performed using the <code>invert.auto</code> function, which uses the Metropolis Hastings MCMC algorithm to invert an arbitrary model. There are a lot of configuration options to <code>invert.auto</code>, so the recommended way to perform an inversion is to start with a default settings list, provided by the package itself. In the following sample, we demonstrate the default inversion of the PROSPECT model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">invert.options &lt;-<span class="st"> </span>default.settings.prospect</code></pre></div>
<p>The model to be inverted is, in this case, just a one-line call to the PROSPECT 5 model with the params vector. It returns a vector of reflectance values. The requirement is that the “model” output be as long as the length (or number of rows) of the observation vector (or matrix). In this case, the PROSPECT model returns 2101 reflectance values, so our observation also has to have this many points.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">invert.options<span class="op">$</span>model</code></pre></div>
<p>The recommended way to set settings is to start with a default object and modify it. For example, in the following block, we reduce the length of the run to make it go a little faster.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">invert.options<span class="op">$</span>n.tries &lt;-<span class="st"> </span><span class="dv">1</span>      <span class="co"># Number of attempts</span>
invert.options<span class="op">$</span>nchains &lt;-<span class="st"> </span><span class="dv">2</span>      <span class="co"># Number of MCMC chains</span>
invert.options<span class="op">$</span>ngibbs &lt;-<span class="st"> </span><span class="dv">5000</span>    <span class="co"># Number of iterations per chain</span>
invert.options<span class="op">$</span>burnin &lt;-<span class="st"> </span><span class="dv">1000</span>    <span class="co"># Length of burnin period</span>
invert.options<span class="op">$</span>do.lsq.first &lt;-<span class="st"> </span><span class="ot">TRUE</span> <span class="co"># Initialize with results from a fast least-squares optimization algorithm</span></code></pre></div>
<p>The full list of inversion options is below. See the documentation for <code>invert.auto</code> for a full description of each of these.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>(invert.options)</code></pre></div>
<p>Now, we load some test data (for <em>Acer rubrum</em> leaves (<code>testspec_ACRU</code>, accessible through <code>data(testspec)</code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(testspec)
observed &lt;-<span class="st"> </span>testspec_ACRU[,<span class="dv">1</span>]
<span class="kw">plot</span>(wl, observed, <span class="dt">xlab=</span><span class="st">"Wavelength"</span>, <span class="dt">ylab=</span><span class="st">"Reflectance"</span>, <span class="dt">type=</span><span class="st">'l'</span>)</code></pre></div>
<p>To perform an inversion, just pass the observation matrix and the inversion settings into <code>invert.auto</code> (NOTE: <code>quiet = TRUE</code> suppresses the progress bar, which is done here to clean up the knitted document. <code>threshold = ...</code> sets the maximum value of the multivariate Gelman Diagnostic used to assess convergence – it defaults to 1.1, but we set it higher here for demosntrative purposes).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span>(<span class="kw">file.exists</span>(<span class="st">"inversion.output.rds"</span>)){
    inversion.output &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">"inversion.output.rds"</span>)
} <span class="cf">else</span> {
    inversion.output &lt;-<span class="st"> </span><span class="kw"><a href="../reference/invert.auto.html">invert.auto</a></span>(<span class="dt">observed =</span> observed,
                                    <span class="dt">invert.options =</span> invert.options,
                                    <span class="dt">quiet =</span> <span class="ot">TRUE</span>,
                                    <span class="dt">threshold =</span> <span class="fl">1.3</span>)
    <span class="kw">saveRDS</span>(inversion.output, <span class="st">"inversion.output.rds"</span>)
}</code></pre></div>
<p>The output of <code>invert.auto</code> is a list of two objects: A list of summary statistics for each parameter and an <code>mcmc.list</code> object of the samples for diagnostic purposes or calculation of other summary statistics.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))
<span class="kw">plot</span>(inversion.output<span class="op">$</span>samples, <span class="dt">auto.layout=</span><span class="ot">FALSE</span>)

<span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))
samples.mat &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(inversion.output<span class="op">$</span>samples)[<span class="op">-</span>(<span class="dv">2000</span><span class="op">:</span><span class="dv">0</span>),<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]
<span class="kw">colnames</span>(samples.mat) &lt;-<span class="st"> </span>params.prospect5
<span class="kw">pairs</span>(samples.mat, <span class="dt">pch=</span><span class="st">"."</span>)

means &lt;-<span class="st"> </span><span class="kw">unlist</span>(inversion.output<span class="op">$</span>results[<span class="kw">grep</span>(<span class="st">"mu"</span>, <span class="kw">names</span>(inversion.output<span class="op">$</span>results))])[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]
prospect.sim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prospect.html">prospect</a></span>(means, <span class="dv">5</span>)[,<span class="dv">1</span>]  <span class="co"># reflectance</span>

<span class="kw">plot</span>(wl, observed, <span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">col=</span><span class="dv">1</span>, <span class="dt">xlab=</span><span class="st">"wavelength (nm)"</span>, <span class="dt">ylab=</span><span class="st">"reflectance"</span>)
<span class="kw">lines</span>(wl, prospect.sim, <span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">col=</span><span class="dv">2</span>)
<span class="kw">legend</span>(<span class="st">"topright"</span>, <span class="kw">c</span>(<span class="st">"observed"</span>, <span class="st">"predicted"</span>), <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">col=</span><span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#installation">Installation</a></li>
      <li>
<a href="#overview-of-features">Overview of features</a><ul class="nav nav-pills nav-stacked">
<li><a href="#simulating-reflectance">Simulating reflectance</a></li>
      <li><a href="#inversion">Inversion</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by .</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
