# Creates a plot of the nc files generated by the workflow
# @author Luke Dramko
library("tidyverse")

graph_dir = "./graphs/"
args = commandArgs(trailingOnly = TRUE)
if (is.na(args[1])) {
  print("Please include a start date or workflow id.")
  exit("Missing input parameter")
}
# Validate date
start_date <- tryCatch(as.POSIXct(args[1]), error = function(e) {NULL} )
if (is.null(start_date)) {
  in_wid <- as.integer(args[1])
}
# Set up database connection
dbparms = list()
dbparms$dbname = "bety"
dbparms$host = "128.197.168.114"
dbparms$user = "bety"
dbparms$password = "bety"
#Connection code copied and pasted from met.process
bety <- dplyr::src_postgres(dbname   = dbparms$dbname, 
                            host     = dbparms$host, 
                            user     = dbparms$user, 
                            password = dbparms$password)
con <- bety$con #Connection to the database.  dplyr returns a list.
# Identify the workflow with the proper information
if (!is.null(start_date)) {
  workflows <- PEcAn.DB::db.query(paste0("SELECT * FROM workflows WHERE start_date='", format(start_date, "%Y-%m-%d %H:%M:%S"), 
                                         "' ORDER BY id"), con)
} else {
  workflows <- PEcAn.DB::db.query(paste0("SELECT * FROM workflows WHERE id='", in_wid, "'"), con)
}
print(workflows)
if (nrow(workflows) == 0) {
  print("No workflow found.")
  quit("no")
}
if (nrow(workflows) > 1) {
  print("Multiple workflows found: Using the latest")
  workflow <- workflows[nrow(workflows),]
} else {
  workflow <- workflows
}
print(paste0("Using workflow ", workflow$id))
wid <- workflow$id
pecan_out_dir <- paste0("/fs/data3/ldramko/output/PEcAn_", wid, "/out/");
pecan_out_dirs <- list.dirs(path = pecan_out_dir)
if (is.na(pecan_out_dirs[1])) {
  print(paste0(pecan_out_dirs, " does not exist."))
  quit("no")
}
neemat <- matrix(1:64, nrow=1, ncol=64) # Proxy row, will be deleted later.
qlemat <- matrix(1:64, nrow=1, ncol=64) # Proxy row, will be deleted later.
num_results <- 0;
for (i in 1:length(pecan_out_dirs)) {
  datafile <- file.path(pecan_out_dirs[i], format(workflow$start_date, "%Y.nc"))
  if (!file.exists(datafile)) {
    print(paste0("File ", datafile, " does not exist."))
    next
  }
  
  num_results <- num_results + 1
  
  #open netcdf file
  ncptr <- ncdf4::nc_open(datafile);
  
  # Attach data to matricies
  nee <- ncdf4::ncvar_get(ncptr, "NEE")
  neemat <- rbind(neemat, nee)
  
  qle <- ncdf4::ncvar_get(ncptr, "Qle")
  qlemat <- rbind(qlemat, qle)
  
  # Close netcdf file
  ncdf4::nc_close(ncptr)
}
if (num_results == 0) {
  print("No results found.")
  quit("no")
} else {
  print(paste0(num_results, " results found."))
}
# Strip away proxy rows
neemat <- neemat[-1,]
qlemat <- qlemat[-1,]
# Time
time <- seq(6, 6 * ncol(neemat), by=6)
# Caluclate means
neemins <- NULL
neemaxes <- NULL
quantiles <- apply(neemat,2,quantile,c(0.025,0.5,0.975), na.rm=TRUE)
neelower95 <- quantiles[1,]
neemeans <- quantiles[2,]
neeupper95 <- quantiles[3,]
# Determines outliers... not requested anymore
# for (i in 1:ncol(neemat)) {
#  without_outliers <- neemat[,i]
#  without_outliers <- without_outliers[!without_outliers %in% boxplot.stats(without_outliers)$out]
#  neemins <- c(neemins, min(without_outliers))
#  neemaxes <- c(neemaxes, max(without_outliers))
#}
needf <- data.frame(time = time, lower = neelower95, means = neemeans, upper = neeupper95)
quantiles <- apply(qlemat,2,quantile,c(0.025,0.5,0.975), na.rm=TRUE)
qlelower95 <- quantiles[1,]
qlemeans <- quantiles[2,]
qleupper95 <- quantiles[3,]
qledf <- data.frame(time = time, lower = qlelower95, means = qlemeans, upper = qleupper95)
# Reshape data for data frame
#time <- factor(rep(seq(6, 6 * 64, by=6), each=num_results))
#nee = NULL; # An empty vector
#for (i in 1:ncol(neemat)) {
#  nee <- c(nee, neemat[,i])
#}
#qle = NULL;
#for (i in 1:ncol(qlemat)) {
#  qle <- c(qle, qlemat[,i])
#}
#
# Put data into data frame for ggplot
#needf <- data.frame(time = time,
#                    nee = nee)
#qledf <- data.frame(time = time,
#                     qle = qle)

# Grab real data
real_data <- PEcAn.data.atmosphere::download.US_WCr(workflow$start_date, workflow$end_date, timestep=6)
needf$real_nee <- real_data$nee
qledf$real_qle <- real_data$qle

# Create plots
neeplot <- ggplot(needf) + 
  # geom_ribbon(aes(x=time, ymin=neemins, ymax=neemaxes, fill="Spread of data (excluding outliers)"), alpha = 0.7) +
  geom_ribbon(aes(x = time, ymin=neelower95, ymax=neeupper95, fill="95% confidence interval"), alpha = 0.4) + 
  geom_line(aes(x=time, y=neemeans, color="predicted mean")) +
  geom_point(aes(x=time, y=real_data$nee, color="actual data")) +
  ggtitle(paste0("Net Ecosystem Exchange for ", workflow$start_date, " to ", workflow$end_date, "")) +
  scale_x_continuous(name="Time (hours)") + scale_y_continuous(name="NEE (kg C m-2 s-1)") + 
  scale_colour_manual(name='Legend', values=c("predicted mean"="lightskyblue1", "actual data"="darkorange3")) +
  scale_fill_manual(name='Legend', values=c("95% confidence interval" = "blue3", "mean"="lightskyblue1"))
  qleplot <- ggplot(qledf) +
 # geom_ribbon(aes(x=time, ymin=qlemins, ymax=qlemax, fill="Spread of data (excluding outliers)"), alpha=0.7) +
  geom_ribbon(aes(x=time, ymin=qlelower95, ymax=qleupper95, fill="95% confidence interval"), alpha = 0.4) +
  geom_line(aes(x=time, y=qlemeans, color="mean")) +
  geom_point(aes(x=time, y=real_data$qle, color="actual data")) +
  ggtitle(paste0("LE for ", workflow$start_date, " to ", workflow$end_date, ", \nSummary of All Ensembles")) +
  scale_x_continuous(name="Time (hours)") + scale_y_continuous(name="LE (W m-2 s-1)") +
  scale_color_manual(name='Legend', values=c("mean"="lightskyblue1", "actual data"="darkorange3")) + 
  scale_fill_manual(name='Legend', values=c("95% confidence interval" = "blue3"))
  
if (!dir.exists(graph_dir)) {
  dir.create(graph_dir, recursive = TRUE)
}
print("Saving plots")
# save(neeplot, file="plot.Rdata")
pdf(file.path(graph_dir, paste0(format(workflow$start_date, "%Y-%m-%dT%H:%M:%SNEE"), ".pdf")), width = 6, height = 3)
plot(neeplot)
plot(qleplot)
dev.off()
