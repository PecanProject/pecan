Temporally Downscale Meteorology
===============


### Subdaily Training Data

Examples:

* Fluxnet2015 30-minute/hourly
* Ameriflux 30-minute/hourly

### Extract Training Data and Merge All Years Into 1 File 

```{r}
library(PEcAn.data.atmosphere)
library(PEcAn.DB)
sitename   <- 'Niwot Ridge Forest/LTER NWT1'
outfolder  <- dir.create(file.path('~/Example'))
start_date <- '2000/01/01'
end_date   <- '2014/12/31'
download.Fluxnet2015(username = 'pecan', overwrite = FALSE)

bety      <- dplyr::src_postgres(host = bety$host, user = bety$user, password = bety$password, dbname = bety$dbname)
format    <- query.format.vars(input.id = 5000000005, bety = bety)
in.prefix <- 'FLX_US-NR1_FLUXNET2015_SUBSET_HH_1998-2014_1-3'
in.path   <- outfolder
outfolder <- dir.create(file.path(outfolder,"CF"))
lat       <- 40.0329
lon       <- -105.546
met2CF.csv() 

in.path   <- outfolder
outfolder <- dir.create(file.path(outfolder,"gapfill"))
lst       <- -7
metgapfill()

in.path   <- outfolder
outfolder <- dir.create(file.path("~/Example/training_data"))
upscale   <- "hour"
nc.merge()
```

### Generate Linear Regression Models From Training Data 

Note: This requires ~ 120 GB of space if using the entire training dataset
```{r}
in.prefix      <- "US-NR1"
dat.train.file <- "~/Example/training_data/FLX_US-NR1_FLUXNET2015_SUBSET_HH_1998-2014_1-3_dat.train.nc"
outfolder      <- dir.create(file.path("~/Example/lm_model_output"))
n.beta         <- 10
day.window     <- 5
gen.subdaily.models()
```

### Coarse Data to Downscale

Examples:

* MACA daily
* CRU-NCEP 6 hourly

### Extract Data We Want To Downscale

```{r}

outfolder       <- "~/Example/"
start_date      <- "2020-01-01"
end_date        <- "2020-12-31"
site_id         <- 772
model           <- "BNU-ESM"
scenario        <- "rcp85"
ensemble_member <- "r1i1p1"
download.MACA()

```

### Predict Subdaily Data Using Statistics From Training Data 

```{r}
outfolder      <- dir.create(file.path("~/Example/downscaled_data"))
in.path        <- "~/Example/MACA_site_0-772"
in.prefix      <- "MACA.BNU-ESM.rcp85.r1i1p1"
lm.models.base <- "~/Example/lm_model_output"
n.ens          <- 3
predict_subdaily_met()
```
