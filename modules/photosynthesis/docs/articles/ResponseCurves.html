<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitting Hierarchical Bayes photosynthetic response curves • PEcAn.photosynthesis</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fitting Hierarchical Bayes photosynthetic response curves">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PEcAn.photosynthesis</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.6.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ResponseCurves.html">Fitting Hierarchical Bayes photosynthetic response curves</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Fitting Hierarchical Bayes photosynthetic response curves</h1>
                        <h4 class="author">Mike Dietze</h4>
            
            <h4 class="date">June 25, 2015</h4>
      
      
      <div class="hidden name"><code>ResponseCurves.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This package is designed to fit the Farquhar, von Caemmerer, and Berry (1980) photosynthesis model [FvCB model] to leaf-level photosynthetic data. The statistical model generalizes the Hierarchial Bayesian approach described in Feng and Dietze (2013). The important advance that this approach provides is the ability to include covariates (e.g. leaf traits) in a mixed effects model describing key model parameters, <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(V_\textrm{cmax}\)</span>. At the moment the only supported random effect is a leaf-level effect, however fixed effects can be specified using standard R linear model notation, including interaction terms.</p>
<p>This package includes functions for: loading photosynthetic data in the common LI-COR text-based format, performing visual QA/QC on that data, fitting the model to data, and generating diagnostic response-curve plots with confidence and predictive intervals. The diagnostic and QA/QC functions assume that data was collected as CO2 and light response curves (A-Ci and A-Q respectively). This assumption is not required for model fitting, so alternative sampling designs are allowed, as described by Dietze (2014).</p>
<p>The version of the FvCB model used is described below, and at the moment does not include the TPU limitation term or temperature corrections (i.e. all data are assumed to be collected at the same leaf temperature, all parameters are specific to that temperature). It also assumes that electron transport rate, J, is a saturating function of <span class="math inline">\(J_{\textrm{max}}\)</span>.</p>
<p><span class="math display">\[A_j = \frac{\alpha Q}{\sqrt{1+(\alpha^2 Q^2)/(J_\textrm{max}^2)}} \frac{C_i- \Gamma}{4 C_i + 8 \Gamma}\]</span></p>
<p><span class="math display">\[A_c = V_{\textrm{cmax}} \frac{C_i - \Gamma}{C_i+ K_C (1+[O]/K_O) }\]</span></p>
<p><span class="math display">\[A^{(m)} = min(A_j,A_c) - r\]</span></p>
<p><span class="math display">\[A^{(o)} \sim N(A^{(m)},\tau)\]</span></p>
<table class="table">
<thead><tr class="header">
<th>Parameter</th>
<th>Symbol</th>
<th>Definition</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>alpha0</td>
<td><span class="math inline">\(\alpha\)</span></td>
<td>quantum yield (mol electrons/mole photon)</td>
</tr>
<tr class="even">
<td>Jmax</td>
<td><span class="math inline">\(J_{\textrm{max}}\)</span></td>
<td>maximum electron transport</td>
</tr>
<tr class="odd">
<td>cp</td>
<td><span class="math inline">\(\Gamma\)</span></td>
<td>CO2 compensation point</td>
</tr>
<tr class="even">
<td>vmax0</td>
<td><span class="math inline">\(V_{\textrm{cmax}}\)</span></td>
<td>maximum Rubisco capacity (a.k.a Vcmax)</td>
</tr>
<tr class="odd">
<td>r</td>
<td><span class="math inline">\(R_\textrm{d}\)</span></td>
<td>leaf respiration</td>
</tr>
<tr class="even">
<td>tau</td>
<td><span class="math inline">\(\tau\)</span></td>
<td>residual precision</td>
</tr>
<tr class="odd">
<td>q</td>
<td><span class="math inline">\(Q\)</span></td>
<td>PAR</td>
</tr>
<tr class="even">
<td>pi</td>
<td><span class="math inline">\(C_\textrm{i}\)</span></td>
<td>CO2 concentration</td>
</tr>
</tbody>
</table>
<p>The ‘Parameter’ above refers to how the variable is referenced in the code, and thus the name that will be returned by the statistical fit.</p>
<p>The hierarchical version of this model is equivalent to the standard model except that <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(V_\textrm{cmax}\)</span> are mixed effect linear models of any covariates specified. These linear models assume uninformative Normal priors, while the random effects and residual errors are assumed to have Gamma priors on their precisions. All other priors are as described below in the example code. The FvCB model is fit using JAGS via the <em>rjags</em> package so outputs are <em>coda</em> mcmc.list objects that can be assessed and manipulated using standard tools in the <em>coda</em> package.</p>
</div>
<div id="install-package-from-github" class="section level2">
<h2 class="hasAnchor">
<a href="#install-package-from-github" class="anchor"></a>Install package from Github</h2>
<p>You should only have to do this once, and you only have to do this if you are downloading just this package separate from the rest of PEcAn</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(<span class="st">"PEcAn.photosynthesis"</span>, <span class="dt">character.only =</span> <span class="ot">TRUE</span>)) {
  devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"PecanProject/pecan/modules/photosynthesis"</span>) 
}
knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(<span class="dt">cache =</span> <span class="ot">TRUE</span>)</code></pre></div>
</div>
<div id="load-library-and-example-data" class="section level2">
<h2 class="hasAnchor">
<a href="#load-library-and-example-data" class="anchor"></a>Load library and example data</h2>
<p>In this example we are using a set of files that are built into the package, but you could easily replace <em>filenames</em> with vector of your own filenames, for example using <em>list.files</em> to look up all the files in a directory</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(PEcAn.photosynthesis)

## Get list of LI-COR 6400 file names (ASCII not xls)
filenames &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="kw">paste0</span>(<span class="st">"flux-course-"</span>,<span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>,<span class="dt">each=</span><span class="dv">2</span>),<span class="kw">c</span>(<span class="st">"aci"</span>,<span class="st">"aq"</span>)), <span class="dt">package =</span> <span class="st">"PEcAn.photosynthesis"</span>)

## Load files to a list
master =<span class="st"> </span><span class="kw">lapply</span>(filenames, read_Licor)</code></pre></div>
</div>
<div id="run-qaqc-checks" class="section level2">
<h2 class="hasAnchor">
<a href="#run-qaqc-checks" class="anchor"></a>run QA/QC checks</h2>
<p>The code below performs a set of interactive QA/QC checks on the LI-COR data that’s been loaded. Because it’s interactive it isn’t run when this vignette is knit.</p>
<p>If you want to get a feel for how the code works you’ll want to run it first on just one file, rather than looping over all the files</p>
<pre><code>master[[1]] &lt;- Licor_QC(master[[1]])</code></pre>
<p>On the first screen you will be shown an A-Ci curve. Click on points that are outliers that you want to remove. Be aware that these points will not change color in <strong>THIS SCREEN</strong>, but will be updated in the next. Also be aware that if your data set is not an A-Ci curve (or contains both A-Ci and A-Q curves) there are points that may look like outliers just because they are data from the other curve. When you are done selecting outliers, click <strong>[esc]</strong> to move to the next screen.</p>
<p>The second screen then verifies the status of point selections from the first screen and gives you an opportunity to unselect points that had been flagged as ‘fail’.</p>
<p>The third and fourth screens are the equivalent plots for the A-Q (light response) curves.</p>
<p>Finally, this function returns a copy of the original data with a new column, “QC”, added. This column will flag all passed values with 1, all unchecked values with 0, and all failed values with -1.</p>
<p>The function Licor_QC has an optional arguement, <em>curve</em>, which can be set to either “ACi” or “AQ” if you only want to perform one of these diagnostics rather than both (which is the default).</p>
<p>Also, the QC code attempts to automatically separate which points are part of the ACi curve from which parts are part of the AQ curve, based on how close points are to the the variable which is supposed to be held constant. The optional variable “tol” controls the tolerance of this filter, and is expressed as a proportion of the fixed value. The default value, 0.05, corresponds to a 5% deviation. For example, in the ACi curve the light level should be held constant so the code filters the PARi variable to find the mode and then included any data that’s within 5% of the mode in the ACi curve.</p>
<p>Once you have a feel for the QA/QC function, you’ll want to run it for all the data you’ve loaded.</p>
<pre><code>for(i in 1:length(master)){
    master[[i]] = Licor_QC(master[[i]])
}</code></pre>
</div>
<div id="merge-data-into-one-data-frame" class="section level2">
<h2 class="hasAnchor">
<a href="#merge-data-into-one-data-frame" class="anchor"></a>Merge data into one data frame</h2>
<p>Once data been’s checked we’ll merge it into one large data frame</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">"rbind"</span>, master)

## if QC was done, remove both unchecked points and those that fail QC
<span class="cf">if</span>(<span class="st">"QC"</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(dat)){
  dat &lt;-<span class="st"> </span>dat[<span class="op">-</span><span class="kw">which</span>(dat<span class="op">$</span>QC <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span>),]  
} <span class="cf">else</span> {
  QC &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">nrow</span>(dat))
  dat &lt;-<span class="st"> </span><span class="kw">cbind</span>(dat, QC)
}</code></pre></div>
</div>
<div id="fit-fvcb-model-to-composite-data" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-fvcb-model-to-composite-data" class="anchor"></a>Fit FvCB model to composite data</h2>
<p>If you only want to fit the model to the data from one leaf you could do this as</p>
<pre><code>fit1 &lt;- fitA(master[[1]])</code></pre>
<p>Where the one required argument is the data frame of photosynthetic data. However, this code also allows use to fit the FvCB model to all of the data at once.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span>(<span class="kw">file.exists</span>(<span class="st">"fit.RData"</span>)){
  <span class="kw">load</span>(<span class="st">"fit.RData"</span>)
} <span class="cf">else</span>{
  fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitA.html">fitA</a></span>(dat)
  <span class="kw">save</span>(fit, <span class="dt">file =</span> <span class="st">"fit.RData"</span>)
}</code></pre></div>
<p>Because the MCMC can take a bit of time to run, in this example the code is written to load the existing fit if it exists, which just makes knitting the vignette more efficient.</p>
<p>The returned object is a list with two mcmc.lists, “params” and “predict”, and the text of the JAGS model that was fit. We can look at this model below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">writeLines</span>(fit<span class="op">$</span>model)</code></pre></div>
<p>Note that the lines beginning with # are comments. Some of these comments are followed by specific tags, such as RLEAF.V and RLEAF.A, which are bits of code that will get turned on when we specify leaf random effects (see below).</p>
<p>The ‘params’ mcmc.list contains the parameter estimate MCMC chains, which we can do standard MCMC diagnositics on.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>))
<span class="kw">plot</span>(fit<span class="op">$</span>params, <span class="dt">auto.layout =</span> <span class="ot">FALSE</span>)    ## MCMC diagnostic plots
<span class="kw">summary</span>(fit<span class="op">$</span>params) ## parameter estimates  
<span class="kw">gelman.plot</span>(fit<span class="op">$</span>params, <span class="dt">auto.layout =</span> <span class="ot">FALSE</span>)
<span class="kw">gelman.diag</span>(fit<span class="op">$</span>params)</code></pre></div>
<p>The ‘predict’ object can be used to perform standard predictive diagnostics and to construct CI around curves</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## predicted vs observed plot
<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))
mstats &lt;-<span class="st"> </span><span class="kw">summary</span>(fit<span class="op">$</span>predict)
pmean &lt;-<span class="st"> </span>mstats<span class="op">$</span>statistics[<span class="kw">grep</span>(<span class="st">"pmean"</span>, <span class="kw">rownames</span>(mstats<span class="op">$</span>statistics)), <span class="dv">1</span>]
<span class="kw">plot</span>(pmean, dat<span class="op">$</span>Photo, <span class="dt">pch =</span> <span class="st">"+"</span>, <span class="dt">xlab =</span> <span class="st">"Predicted A"</span>, <span class="dt">ylab =</span> <span class="st">"Observed A"</span>)
<span class="kw">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">col =</span> <span class="dv">2</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)
  
##   
<span class="kw"><a href="../reference/plot_photo.html">plot_photo</a></span>(dat, fit)</code></pre></div>
</div>
<div id="refit-with-leaf-level-random-effects" class="section level2">
<h2 class="hasAnchor">
<a href="#refit-with-leaf-level-random-effects" class="anchor"></a>Refit with leaf-level random effects</h2>
<p>Next, let’s look at how to specify leaf-level random effects in the model. To do so we’re going to add an extra arguement to the function, which is a list of model specifications.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">A.model &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">a.fixed =</span> <span class="ot">NULL</span>, <span class="dt">a.random =</span> <span class="st">"leaf"</span>, 
                <span class="dt">V.fixed =</span> <span class="ot">NULL</span>, <span class="dt">V.random =</span> <span class="st">"leaf"</span>, 
                <span class="dt">n.iter =</span> <span class="dv">5000</span>, <span class="dt">match =</span> <span class="st">"fname"</span>)</code></pre></div>
<p>In this list a refers to <span class="math inline">\(\alpha\)</span> and V refers to <span class="math inline">\(V_\textrm{cmax}\)</span>. Fixed refers to the specification of the fixed effects, which we’re leaving unspecified at the moment (NULL). Random refers to the specification of random effects, which we’re setting to ‘leaf’ in order allow <span class="math inline">\(alpha\)</span> and <span class="math inline">\(V_\textrm{cmax}\)</span> to vary on a leaf-by-leaf basis. Note: at the moment ‘leaf’ is the only valid random effect, though in the future we hope to allow the specification of arbitrary random effects in a covariate file (see next section for how to specify covariates). Next, <em>n.iter</em> refers to the number of MCMC iterations run by the model. Here we’re setting that to 5000, which is the default. You can increase this if you find the model isn’t converging. For example, if you wanted to increase the iterations with the previous default model, you would set all the fixed and random effects to NULL but increase n.iter. Finally, match is the variable used both to group records into individual leaves and to match individual leaves to covariate data. If you look at our photosynthesis dataframe, <em>dat</em>, you’ll see that it has a column <em>fname</em> that corresponds to the filename the data was read from (here we’re assuming each file contains the data for one leaf, but it’s not hard to add columns to your data if you want to group things in other ways)</p>
<p>Once the model is specified, the fitting and diagnostics are the same as before.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span>(<span class="kw">file.exists</span>(<span class="st">"fitI.RData"</span>)){
  <span class="kw">load</span>(<span class="st">"fitI.RData"</span>)
} <span class="cf">else</span>{
  fitI &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitA.html">fitA</a></span>(dat,<span class="dt">model =</span> A.model)
  <span class="kw">save</span>(fitI, <span class="dt">file=</span><span class="st">"fitI.RData"</span>)
}

<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>))
<span class="kw">plot</span>(fitI<span class="op">$</span>params, <span class="dt">auto.layout =</span> <span class="ot">FALSE</span>)    ## MCMC diagnostic plotssummary
<span class="kw">gelman.plot</span>(fitI<span class="op">$</span>params)
<span class="kw">gelman.diag</span>(fitI<span class="op">$</span>params)

## predicted vs observed plot
<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))
mstats &lt;-<span class="st"> </span><span class="kw">summary</span>(fitI<span class="op">$</span>predict)
pmean &lt;-<span class="st"> </span>mstats<span class="op">$</span>statistics[<span class="kw">grep</span>(<span class="st">"pmean"</span>,<span class="kw">rownames</span>(mstats<span class="op">$</span>statistics)),<span class="dv">1</span>]
<span class="kw">plot</span>(pmean, dat<span class="op">$</span>Photo, <span class="dt">pch =</span> <span class="st">"+"</span>, <span class="dt">xlab =</span> <span class="st">"Predicted A"</span>, <span class="dt">ylab =</span> <span class="st">"Observed A"</span>)
<span class="kw">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dt">col=</span><span class="dv">2</span>,<span class="dt">lwd=</span><span class="dv">2</span>)
  
##   
<span class="kw"><a href="../reference/plot_photo.html">plot_photo</a></span>(dat,fitI)</code></pre></div>
</div>
<div id="fitting-the-model-with-covariates" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-the-model-with-covariates" class="anchor"></a>Fitting the model with covariates</h2>
<p>Next, let’s look at how to fit a model that includes covariates. To begin with let’s load up some covariate data. In this specific case the covariate data, leaf % Nitrogen, is simulated because no covariates were actually measured for these leaves.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cov.data =<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"cov.csv"</span>, <span class="dt">package =</span> <span class="st">"PEcAn.photosynthesis"</span>))
knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(cov.data)</code></pre></div>
<p>To define this model we’ll again define a list of model specifications. Specifically we are going to set <span class="math inline">\(Vcmax\)</span> to be linear functions of leaf N. To do this we’ll set V.fixed “N” and we’ll set V.random to NULL to turn off the leaf random effect. For this example we’ll leave <span class="math inline">\(\alpha\)</span> as random.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">C.model &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">a.fixed =</span> <span class="ot">NULL</span>, <span class="dt">a.random =</span> <span class="st">"leaf"</span>, 
                <span class="dt">V.fixed=</span> <span class="st">"N"</span>, <span class="dt">V.random =</span> <span class="ot">NULL</span>,
                <span class="dt">n.iter =</span> <span class="dv">5000</span>, <span class="dt">match =</span> <span class="st">"fname"</span>)</code></pre></div>
<p>If we had additional covariates, for example SLA and chl (leaf chlorophyll), we might write that model as “N + SLA + chl” if we just wanted the direct effects and “N + SLA + chl + N<em>SLA + N</em>chl + SLA*chl" if we also wanted the pairwise interactions. That said, in this case we don’t have a large enough sample size to justify so many covariates.</p>
<p>Also note that the rows in the photosynthesis data are matched to rows in the covariate data using the column specified in the arguement ‘match’. The default for this, fname, is the filename for the photosynthetic data. Typically one file corresponds to one leaf so each set of traits match to each file. If you have your data organized differently you’ll want to specify a different column match.</p>
<p>To call the <em>fitA</em> function we now have to pass not just the photosynthetic data and the model, but also the covariate data. Otherwise the fit and diagnostics are identical to before.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span>(<span class="kw">file.exists</span>(<span class="st">"fitC.RData"</span>)){
  <span class="kw">load</span>(<span class="st">"fitC.RData"</span>)
} <span class="cf">else</span>{
  fitC &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitA.html">fitA</a></span>(dat,cov.data,<span class="dt">model =</span> C.model)
  <span class="kw">save</span>(fitC,<span class="dt">file=</span><span class="st">"fitC.RData"</span>)
}

<span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))
<span class="kw">plot</span>(fitC<span class="op">$</span>params,<span class="dt">auto.layout =</span> <span class="ot">FALSE</span>)    ## MCMC diagnostic plots
<span class="kw">summary</span>(fitC<span class="op">$</span>params) ## parameter estimates  
<span class="kw">gelman.plot</span>(fitC<span class="op">$</span>params)
<span class="kw">gelman.diag</span>(fitC<span class="op">$</span>params)

## predicted vs observed plot
<span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))
mstats &lt;-<span class="st"> </span><span class="kw">summary</span>(fitC<span class="op">$</span>predict)
pmean &lt;-<span class="st"> </span>mstats<span class="op">$</span>statistics[<span class="kw">grep</span>(<span class="st">"pmean"</span>, <span class="kw">rownames</span>(mstats<span class="op">$</span>statistics)), <span class="dv">1</span>]
<span class="kw">plot</span>(pmean, dat<span class="op">$</span>Photo, <span class="dt">pch =</span> <span class="st">"+"</span>, <span class="dt">xlab =</span> <span class="st">"Predicted A"</span>, <span class="dt">ylab =</span> <span class="st">"Observed A"</span>)
<span class="kw">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dt">col=</span><span class="dv">2</span>,<span class="dt">lwd=</span><span class="dv">2</span>)
  
##   
<span class="kw"><a href="../reference/plot_photo.html">plot_photo</a></span>(dat, fitC)</code></pre></div>
</div>
<div id="citations" class="section level2">
<h2 class="hasAnchor">
<a href="#citations" class="anchor"></a>Citations</h2>
<p>Dietze, M.C. (2014). Gaps in knowledge and data driving uncertainty in models of photosynthesis. Photosynth. Res., 19, 3–14.</p>
<p>Farquhar, G., Caemmerer, S. &amp; Berry, J.A. (1980). A biochemical model of photosynthetic CO2 assimilation in leaves of C3 species. Planta, 149, 78–90.</p>
<p>Feng, X. &amp; Dietze, M.C. (2013). Scale dependence in the effects of leaf ecophysiological traits on photosynthesis: Bayesian parameterization of photosynthesis models. New Phytol., 200, 1132–1144.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#install-package-from-github">Install package from Github</a></li>
      <li><a href="#load-library-and-example-data">Load library and example data</a></li>
      <li><a href="#run-qaqc-checks">run QA/QC checks</a></li>
      <li><a href="#merge-data-into-one-data-frame">Merge data into one data frame</a></li>
      <li><a href="#fit-fvcb-model-to-composite-data">Fit FvCB model to composite data</a></li>
      <li><a href="#refit-with-leaf-level-random-effects">Refit with leaf-level random effects</a></li>
      <li><a href="#fitting-the-model-with-covariates">Fitting the model with covariates</a></li>
      <li><a href="#citations">Citations</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by .</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
