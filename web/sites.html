<!DOCTYPE html>
<html>
<head>
<title>EBI Sites</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<link rel="stylesheet" type="text/css" href="sites.css" />
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript">
      google.load("maps", "3",  {other_params:"sensor=false"});
      google.load("jquery", "1.3.2");

      var map = null;
      var infowindow = null;
      var markersArray = [];

      function resize(){
//        $("#map_canvas").height($(window).height() - $('#form').height() - 10);
        $("#stylized").height($(window).height() - 5);
        $("#map_canvas").height($(window).height() - 1);
        $("#map_canvas").width($(window).width() - $('#form').width() - 5);
      } 

      function initialize() {
        var myLatlng = new google.maps.LatLng(40.11642, -88.243382);
        var myOptions = {
          zoom: 5,
          center: myLatlng,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        }

        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	loadSites();
      }

      function goHome() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            map.panTo(latlng);
            map.setZoom(12);
          }, function() {
            alert("Could not get your location, please make sure you enabled location for safari if you use an iPAD.");
          }, {maximumAge:60000, timeout: 20000});
        } else {  
          alert("I'm sorry, but geolocation services are not supported by your browser.");  
        }  
      }

      function loadSites() {
        if (markersArray) {
          for (i in markersArray) {
            markersArray[i].setMap(null);
          }
          markersArray.length = 0;
        }

        var url="sites.php?met=" + $('#met').is(':checked');
        jQuery.get(url, {}, function(data) {
          jQuery(data).find("marker").each(function() {
            // create a marker
            var marker = jQuery(this);
            var latlng = new google.maps.LatLng(parseFloat(marker.attr("lat")), parseFloat(marker.attr("lon")));
            var gmarker = new google.maps.Marker({position: latlng, map: map});
            markersArray.push(gmarker);

            // create the tooltip and its text
            var info='<b>'+marker.attr("sitename")+'</b><br/>'+marker.attr("city") + ', ' + marker.attr("country") + '<br />';
            info += '<a href="selectsite.php?site=' + marker.attr("id") + '">Select Site</a>';
            // add a listener to open the tooltip when a user clicks on one of the markers
            google.maps.event.addListener(gmarker, 'click', function() {
              if (infowindow) infowindow.close();
              infowindow = new google.maps.InfoWindow({content: info});
              infowindow.open(map, gmarker);
            });
          });
        });
      }

      window.onresize = resize;
      window.onload = resize;
      google.setOnLoadCallback(initialize);
    </script>
</head>
<body>
<div id="wrap">
	<div id="stylized">
		<form action="#" id="form">
			<h1>Filter input data.</h1>
			<p>Filter the sites using options below.</p>

			<label>Only sites with MET data</label>
			<input style="width: auto;" id="met" type="checkbox" value="false" onChange="met=loadSites();" />
			<div class="spacer"></div>

			<label>Goto current location</label>
			<input style="width: auto;" id="home" type="button" value="Home" onclick="goHome();" />
			<div class="spacer"></div>
		</form>
	</div>
	<div id="map_canvas"></div>
</div>
</body>
</html>
